<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Grade Mapper & Student Status Check</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            font-family: 'Sarabun', 'Segoe UI', sans-serif;
            color: #e4e4e7;
            padding: 1.5rem;
        }
        .container { max-width: 1100px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 2.5rem; }
        h1 {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #4fd1c5, #63b3ed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        .subtitle { color: #a0aec0; font-size: 1rem; }
        .card {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.25rem;
            transition: all 0.3s ease;
        }
        .card:hover { border-color: rgba(79,209,197,0.3); }
        .card h2 { font-size: 1.15rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .card p.hint { color: #a0aec0; font-size: 0.85rem; margin-bottom: 1rem; }
        .upload-zone {
            border: 2px dashed rgba(79,209,197,0.4);
            border-radius: 12px;
            padding: 2rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(79,209,197,0.02);
        }
        .upload-zone:hover {
            border-color: #4fd1c5;
            background: rgba(79,209,197,0.08);
            transform: translateY(-2px);
        }
        .upload-zone.has-file { border-color: #48bb78; background: rgba(72,187,120,0.1); }
        .upload-zone input { display: none; }
        .upload-zone .icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .upload-zone .filename { font-weight: 600; color: #48bb78; }
        .upload-zone .info { color: #a0aec0; font-size: 0.85rem; margin-top: 0.25rem; }
        .btn {
            background: linear-gradient(135deg, #4fd1c5, #38b2ac);
            color: #1a1a2e;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: inherit;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(79,209,197,0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #e4e4e7; border: 1px solid rgba(255,255,255,0.2); }
        .btn-secondary:hover { background: rgba(255,255,255,0.15); box-shadow: none; }
        select, input[type="number"] {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.2);
            color: #e4e4e7;
            padding: 0.7rem 1rem;
            border-radius: 8px;
            font-size: 0.95rem;
            width: 100%;
            font-family: inherit;
            transition: all 0.3s ease;
        }
        select:focus, input:focus { outline: none; border-color: #4fd1c5; box-shadow: 0 0 0 3px rgba(79,209,197,0.2); }
        label.field { display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.9rem; }
        .form-group { margin-bottom: 1.25rem; }
        .radio-group { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .radio-option {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 180px;
        }
        .radio-option:hover { border-color: rgba(79,209,197,0.4); }
        .radio-option.selected { border-color: #4fd1c5; background: rgba(79,209,197,0.1); }
        .radio-option .title { font-weight: 600; margin-bottom: 0.3rem; }
        .radio-option .desc { font-size: 0.8rem; color: #a0aec0; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1.5rem; }
        .stat-card { background: rgba(255,255,255,0.05); border-radius: 10px; padding: 1rem; text-align: center; }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: #4fd1c5; }
        .stat-value.green { color: #48bb78; }
        .stat-value.red { color: #fc8181; }
        .stat-label { color: #a0aec0; font-size: 0.8rem; margin-top: 0.25rem; }
        .table-wrap { overflow-x: auto; margin-top: 1rem; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 0.7rem 0.6rem; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.08); }
        th { background: rgba(79,209,197,0.1); font-weight: 600; color: #4fd1c5; white-space: nowrap; }
        tr:hover { background: rgba(255,255,255,0.03); }
        .matched { color: #48bb78; }
        .not-found { color: #fc8181; }
        .error-msg { background: rgba(252,129,129,0.15); border: 1px solid rgba(252,129,129,0.3); color: #fc8181; padding: 0.75rem 1rem; border-radius: 8px; margin: 0.75rem 0; font-size: 0.9rem; }
        .step-nav { display: flex; justify-content: center; gap: 0.75rem; margin-bottom: 1.5rem; }
        .step-dot {
            width: 36px; height: 36px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 0.9rem;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }
        .step-dot.active { background: #4fd1c5; color: #1a1a2e; border-color: #4fd1c5; }
        .step-dot.done { background: #48bb78; color: #1a1a2e; border-color: #48bb78; }
        .hidden { display: none !important; }
        .actions { margin-top: 1.5rem; display: flex; gap: 0.75rem; flex-wrap: wrap; }
        footer { text-align: center; margin-top: 2rem; color: #64748b; font-size: 0.85rem; }
        /* Mode selector */
        .mode-selector { display: flex; gap: 0.75rem; justify-content: center; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .mode-btn {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            color: #e4e4e7;
            font-family: inherit;
            font-size: 0.95rem;
            min-width: 220px;
        }
        .mode-btn:hover { border-color: rgba(79,209,197,0.4); background: rgba(79,209,197,0.05); }
        .mode-btn.active { border-color: #4fd1c5; background: rgba(79,209,197,0.12); }
        .mode-btn .mode-icon { font-size: 1.5rem; margin-bottom: 0.3rem; }
        .mode-btn .mode-title { font-weight: 600; }
        .mode-btn .mode-desc { font-size: 0.8rem; color: #a0aec0; margin-top: 0.2rem; }
        /* Status check specific */
        .file-list { margin-top: 0.75rem; }
        .file-item {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.05); border-radius: 8px;
            padding: 0.5rem 0.75rem; margin-bottom: 0.4rem; font-size: 0.85rem;
        }
        .file-item .file-section { color: #4fd1c5; font-weight: 600; }
        .file-item .file-remove { cursor: pointer; color: #fc8181; font-size: 0.8rem; }
        .file-item .file-remove:hover { color: #f56565; }
        .stats-grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 1.5rem; }
        .badge { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
        .badge-green { background: rgba(72,187,120,0.2); color: #48bb78; }
        .badge-red { background: rgba(252,129,129,0.2); color: #fc8181; }
        .badge-yellow { background: rgba(236,201,75,0.2); color: #ecc94b; }
        .badge-blue { background: rgba(99,179,237,0.2); color: #63b3ed; }
        .section-group { margin-bottom: 1.5rem; }
        .section-header {
            font-weight: 600; font-size: 1rem; margin-bottom: 0.5rem;
            padding: 0.5rem 0.75rem; background: rgba(79,209,197,0.1);
            border-radius: 8px; display: flex; align-items: center; gap: 0.5rem;
        }
        .filter-bar { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .filter-btn {
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15);
            color: #e4e4e7; padding: 0.4rem 0.8rem; border-radius: 8px;
            cursor: pointer; font-size: 0.85rem; font-family: inherit; transition: all 0.2s;
        }
        .filter-btn:hover { border-color: rgba(79,209,197,0.4); }
        .filter-btn.active { border-color: #4fd1c5; background: rgba(79,209,197,0.15); color: #4fd1c5; }
        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: 1fr; }
            .stats-grid-4 { grid-template-columns: repeat(2, 1fr); }
            .radio-group { flex-direction: column; }
            .mode-selector { flex-direction: column; align-items: center; }
            h1 { font-size: 1.75rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Canvas Grade Mapper</h1>
            <p class="subtitle">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Canvas LMS</p>
        </header>

        <!-- Mode Selector -->
        <div class="mode-selector">
            <button class="mode-btn active" id="modeMapBtn" onclick="switchMode('map')">
                <div class="mode-icon">üìä</div>
                <div class="mode-title">Map ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                <div class="mode-desc">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤ Canvas</div>
            </button>
            <button class="mode-btn" id="modeCheckBtn" onclick="switchMode('check')">
                <div class="mode-icon">üîç</div>
                <div class="mode-title">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</div>
                <div class="mode-desc">‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Canvas ‡∏Å‡∏±‡∏ö‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
            </button>
        </div>

        <!-- Score Mapping Mode Steps -->
        <div id="mapMode">
        <div class="step-nav">
            <div class="step-dot active" id="dot1">1</div>
            <div class="step-dot" id="dot2">2</div>
            <div class="step-dot" id="dot3">3</div>
            <div class="step-dot" id="dot4">4</div>
        </div>

        <!-- Step 1 -->
        <div class="card" id="step1">
            <h2>1Ô∏è‚É£ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Grade ‡∏à‡∏≤‡∏Å Canvas</h2>
            <p class="hint">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Grades ‡∏à‡∏≤‡∏Å Canvas (Gradebook > Export) ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö CSV ‡∏´‡∏£‡∏∑‡∏≠ Excel</p>
            <div class="hint" style="background:rgba(79,209,197,0.1); padding:0.75rem; border-radius:8px; margin-bottom:1rem; font-size:0.8rem;">
                üìå ‡πÑ‡∏ü‡∏•‡πå Canvas ‡∏à‡∏∞‡∏°‡∏µ columns: Student, ID, SIS User ID, SIS Login ID, Integration ID, Section, ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢ Assignments
            </div>
            <label class="upload-zone" id="canvasZone">
                <input type="file" id="canvasFile" accept=".csv,.xlsx,.xls">
                <div class="icon">üìÅ</div>
                <div id="canvasName">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á</div>
                <div class="info" id="canvasInfo">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .csv, .xlsx</div>
            </label>
            <div id="canvasPreview" class="hidden" style="margin-top:1rem; padding:0.75rem; background:rgba(255,255,255,0.03); border-radius:8px; font-size:0.8rem;"></div>
            <div id="canvasError" class="error-msg hidden"></div>
            <div style="margin-top:1rem;">
                <button class="btn" id="btnNext1" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
            </div>
        </div>

        <!-- Step 2 -->
        <div class="card hidden" id="step2">
            <h2>2Ô∏è‚É£ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
            <p class="hint">‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ID ‡∏´‡∏£‡∏∑‡∏≠ Email (‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á) - ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏à‡∏∞‡πÉ‡∏ä‡πâ Email ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å</p>
            <div id="errorBox" class="error-msg hidden"></div>
            <label class="upload-zone" id="scoreZone">
                <input type="file" id="scoreFile" accept=".csv,.xlsx,.xls">
                <div class="icon">üìä</div>
                <div id="scoreName">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                <div class="info" id="scoreInfo">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .csv, .xlsx</div>
            </label>
            <div style="margin-top:1rem;">
                <button class="btn btn-secondary" id="btnBack2">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                <button class="btn" id="btnNext2" disabled style="margin-left:0.5rem;">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
            </div>
        </div>

        <!-- Step 3 -->
        <div class="card hidden" id="step3">
            <h2>3Ô∏è‚É£ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£ Map ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
            <div class="form-group">
                <label class="field">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Assignment ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤:</label>
                <select id="assignmentSelect"></select>
            </div>
            <div class="form-group">
                <label class="field">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</label>
                <div class="radio-group">
                    <div class="radio-option selected" id="modeScore" data-mode="score">
                        <div class="title">üìù ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å Column</div>
                        <div class="desc">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å column ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå</div>
                    </div>
                    <div class="radio-option" id="modeAttend" data-mode="attendance">
                        <div class="title">‚úÖ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</div>
                        <div class="desc">‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå = ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</div>
                    </div>
                </div>
            </div>
            <div class="form-group" id="scoreColGroup">
                <label class="field">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Column ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</label>
                <select id="scoreColSelect"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å column --</option></select>
            </div>
            <div class="form-group hidden" id="attendScoreGroup">
                <label class="field">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏´‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£):</label>
                <input type="number" id="attendScore" value="1" min="0" step="0.1" style="max-width:150px;">
            </div>
            <div>
                <button class="btn btn-secondary" id="btnBack3">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                <button class="btn" id="btnMap" style="margin-left:0.5rem;">üîÑ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ Map ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            </div>
        </div>

        <!-- Step 4 -->
        <div class="card hidden" id="step4">
            <h2>4Ô∏è‚É£ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£ Map ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="statTotal">0</div><div class="stat-label">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
                <div class="stat-card"><div class="stat-value green" id="statMatched">0</div><div class="stat-label">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div></div>
                <div class="stat-card"><div class="stat-value red" id="statNotFound">0</div><div class="stat-label">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div></div>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
                            <th>ID</th>
                            <th>Email</th>
                            <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏î‡∏¥‡∏°</th>
                            <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡∏°‡πà</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody"></tbody>
                </table>
            </div>
            <div class="actions">
                <button class="btn" id="btnExport">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Import Canvas</button>
                <button class="btn btn-secondary" id="btnReset">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>

        </div><!-- end mapMode -->

        <!-- Student Status Check Mode -->
        <div id="checkMode" class="hidden">
        <div class="step-nav">
            <div class="step-dot active" id="chkDot1">1</div>
            <div class="step-dot" id="chkDot2">2</div>
            <div class="step-dot" id="chkDot3">3</div>
        </div>

        <!-- Check Step 1: Upload Canvas -->
        <div class="card" id="chkStep1">
            <h2>1Ô∏è‚É£ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Grade ‡∏à‡∏≤‡∏Å Canvas</h2>
            <p class="hint">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Grades ‡∏à‡∏≤‡∏Å Canvas (Gradebook > Export) - ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Assignment</p>
            <div class="hint" style="background:rgba(79,209,197,0.1); padding:0.75rem; border-radius:8px; margin-bottom:1rem; font-size:0.8rem;">
                üìå ‡πÑ‡∏ü‡∏•‡πå Canvas ‡∏à‡∏∞‡∏°‡∏µ columns: Student, ID, SIS User ID, SIS Login ID, Integration ID, Section
            </div>
            <label class="upload-zone" id="chkCanvasZone">
                <input type="file" id="chkCanvasFile" accept=".csv,.xlsx,.xls">
                <div class="icon">üìÅ</div>
                <div id="chkCanvasName">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á</div>
                <div class="info" id="chkCanvasInfo">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .csv, .xlsx</div>
            </label>
            <div id="chkCanvasPreview" class="hidden" style="margin-top:1rem; padding:0.75rem; background:rgba(255,255,255,0.03); border-radius:8px; font-size:0.8rem;"></div>
            <div id="chkCanvasError" class="error-msg hidden"></div>
            <div style="margin-top:1rem;">
                <button class="btn" id="chkBtnNext1" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
            </div>
        </div>

        <!-- Check Step 2: Upload Registrar Files -->
        <div class="card hidden" id="chkStep2">
            <h2>2Ô∏è‚É£ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
            <p class="hint">‡πÑ‡∏ü‡∏•‡πå CSV ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° section - ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå: ‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤(6 ‡∏ï‡∏±‡∏ß) + lecture section(3 ‡∏ï‡∏±‡∏ß) + lab section(3 ‡∏ï‡∏±‡∏ß) ‡πÄ‡∏ä‡πà‡∏ô 261111802000.csv</p>
            <div class="hint" style="background:rgba(79,209,197,0.1); padding:0.75rem; border-radius:8px; margin-bottom:1rem; font-size:0.8rem;">
                üìå ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢: ID, NAME, SNAME, Column1_1, FACID, FACNAME
            </div>
            <label class="upload-zone" id="regZone">
                <input type="file" id="regFiles" accept=".csv,.xlsx,.xls" multiple>
                <div class="icon">üìã</div>
                <div id="regName">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)</div>
                <div class="info" id="regInfo">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .csv, .xlsx - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô</div>
            </label>
            <div id="regFileList" class="file-list"></div>
            <div id="regError" class="error-msg hidden"></div>
            <div style="margin-top:1rem;">
                <button class="btn btn-secondary" id="chkBtnBack2">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                <button class="btn" id="chkBtnCompare" disabled style="margin-left:0.5rem;">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
            </div>
        </div>

        <!-- Check Step 3: Results -->
        <div class="card hidden" id="chkStep3">
            <h2>3Ô∏è‚É£ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h2>
            <div class="stats-grid-4" id="chkStatsGrid">
                <div class="stat-card"><div class="stat-value" id="chkStatCanvas">0</div><div class="stat-label">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏ô Canvas</div></div>
                <div class="stat-card"><div class="stat-value" id="chkStatReg">0</div><div class="stat-label">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div></div>
                <div class="stat-card"><div class="stat-value green" id="chkStatMatch">0</div><div class="stat-label">‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (‡∏õ‡∏Å‡∏ï‡∏¥)</div></div>
                <div class="stat-card"><div class="stat-value red" id="chkStatIssue">0</div><div class="stat-label">‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</div></div>
            </div>
            <div class="filter-bar">
                <button class="filter-btn active" data-filter="all" onclick="filterCheckResults('all')">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button class="filter-btn" data-filter="match" onclick="filterCheckResults('match')">‚úÖ ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</button>
                <button class="filter-btn" data-filter="canvas-only" onclick="filterCheckResults('canvas-only')">‚ö†Ô∏è ‡∏°‡∏µ‡πÉ‡∏ô Canvas ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                <button class="filter-btn" data-filter="reg-only" onclick="filterCheckResults('reg-only')">‚ùå ‡∏°‡∏µ‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô Canvas</button>
            </div>
            <div id="chkResultsContainer"></div>
            <div class="actions">
                <button class="btn" id="chkBtnExport">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ CSV</button>
                <button class="btn btn-secondary" id="chkBtnReset">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>
        </div><!-- end checkMode -->

        <footer>
            <p>üìå ‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡πÑ‡∏ü‡∏•‡πå CSV ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏ô‡∏≥‡πÑ‡∏õ Import ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ Canvas ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏°‡∏ô‡∏π Grades > Import</p>
        </footer>
    </div>

    <script>
        // State
        let canvasData = null;
        let scoreData = null;
        let assignments = [];
        let mappingResult = null;
        let currentStep = 1;
        let mappingMode = 'score';

        // Elements
        const canvasFileEl = document.getElementById('canvasFile');
        const scoreFileEl = document.getElementById('scoreFile');
        const canvasZone = document.getElementById('canvasZone');
        const scoreZone = document.getElementById('scoreZone');
        const errorBox = document.getElementById('errorBox');

        // Parse file (CSV or Excel)
        function parseFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                const name = file.name.toLowerCase();

                if (name.endsWith('.csv')) {
                    reader.onload = (e) => {
                        const text = e.target.result;
                        const lines = text.split(/\r?\n/).map(line => {
                            const result = [];
                            let cell = '', inQuotes = false;
                            for (let ch of line) {
                                if (ch === '"') inQuotes = !inQuotes;
                                else if (ch === ',' && !inQuotes) { result.push(cell.trim()); cell = ''; }
                                else cell += ch;
                            }
                            result.push(cell.trim());
                            return result;
                        });
                        resolve({ headers: lines[0] || [], rows: lines.slice(1).filter(r => r.some(c => c)) });
                    };
                    reader.onerror = reject;
                    reader.readAsText(file, 'UTF-8');
                } else {
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const wb = XLSX.read(data, { type: 'array' });
                        const sheet = wb.Sheets[wb.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        resolve({ headers: (json[0] || []).map(h => h?.toString() || ''), rows: json.slice(1).map(r => r.map(c => c?.toString() || '')) });
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                }
            });
        }

        // Update step indicators
        function updateSteps() {
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById('dot' + i);
                const card = document.getElementById('step' + i);
                dot.classList.remove('active', 'done');
                card.classList.add('hidden');
                if (i < currentStep) dot.classList.add('done');
                if (i === currentStep) { dot.classList.add('active'); card.classList.remove('hidden'); }
            }
        }

        // Canvas file upload
        canvasFileEl.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const previewEl = document.getElementById('canvasPreview');
            const errorEl = document.getElementById('canvasError');
            previewEl.classList.add('hidden');
            errorEl.classList.add('hidden');
            
            try {
                canvasData = await parseFile(file);
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå Canvas ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const headers = canvasData.headers.map(h => (h || '').toLowerCase());
                const isCanvasFile = headers[0] === 'student' && 
                                    (headers[1] === 'id' || headers[2]?.includes('sis'));
                
                if (!isCanvasFile) {
                    errorEl.innerHTML = '‚ö†Ô∏è ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÑ‡∏ü‡∏•‡πå Grade ‡∏à‡∏≤‡∏Å Canvas<br><small>‡πÑ‡∏ü‡∏•‡πå Canvas ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ columns: Student, ID, SIS User ID, ...</small>';
                    errorEl.classList.remove('hidden');
                    canvasZone.classList.remove('has-file');
                    document.getElementById('btnNext1').disabled = true;
                    return;
                }
                
                // Extract assignments from column G (index 6) onwards
                // Canvas assignments ‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö‡∏ó‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡πÄ‡∏ä‡πà‡∏ô "Assignment Name (123456)"
                // ‡∏Å‡∏£‡∏≠‡∏á column ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏≠‡∏á Canvas ‡∏≠‡∏≠‡∏Å (Points, Score, read only, Current, Final, Unposted)
                assignments = [];
                const excludePatterns = ['current point', 'final point', 'current score', 'final score', 
                                        'unposted', 'read only', 'imported assignment'];
                canvasData.headers.forEach((h, i) => {
                    if (i >= 6 && h) {
                        const lower = h.toLowerCase();
                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà column ‡∏™‡∏£‡∏∏‡∏õ
                        const isExcluded = excludePatterns.some(p => lower.includes(p));
                        // Assignment ‡∏à‡∏∞‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö ‡πÄ‡∏ä‡πà‡∏ô (123456) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ pattern ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏á
                        const hasAssignmentId = /\(\d+\)/.test(h);
                        if (!isExcluded && (hasAssignmentId || !lower.includes('point') && !lower.includes('score'))) {
                            assignments.push({ index: i, name: h });
                        }
                    }
                });
                
                // ‡πÅ‡∏™‡∏î‡∏á preview
                previewEl.innerHTML = `
                    <div style="color:#4fd1c5; margin-bottom:0.5rem;">‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Canvas:</div>
                    <div>üìã Columns: ${canvasData.headers.slice(0, 6).join(', ')}</div>
                    <div style="margin-top:0.5rem;">üìù Assignments ‡∏ó‡∏µ‡πà‡∏û‡∏ö (${assignments.length}):</div>
                    <ul style="margin:0.25rem 0 0 1.25rem; color:#a0aec0;">
                        ${assignments.slice(0, 5).map(a => `<li>${a.name}</li>`).join('')}
                        ${assignments.length > 5 ? `<li>... ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${assignments.length - 5} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>` : ''}
                    </ul>
                `;
                previewEl.classList.remove('hidden');
                
                canvasZone.classList.add('has-file');
                document.getElementById('canvasName').innerHTML = `<span class="filename">${file.name}</span>`;
                document.getElementById('canvasInfo').textContent = `‡∏û‡∏ö ${assignments.length} assignments`;
                document.getElementById('btnNext1').disabled = assignments.length === 0;
                
                if (assignments.length === 0) {
                    errorEl.textContent = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö Assignment ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)';
                    errorEl.classList.remove('hidden');
                }
            } catch (err) {
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ: ' + err.message);
            }
        });

        // Score file upload
        scoreFileEl.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            errorBox.classList.add('hidden');
            try {
                scoreData = await parseFile(file);
                const headers = scoreData.headers.map(h => h.toLowerCase());
                const hasId = headers.some(h => h === 'id' || h === 'student id' || h === 'sis user id');
                const hasEmail = headers.some(h => h.includes('email') || h === 'sis login id');
                if (!hasId && !hasEmail) {
                    errorBox.textContent = '‚ö†Ô∏è ‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ID ‡∏´‡∏£‡∏∑‡∏≠ Email ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ü‡∏¥‡∏•‡∏î‡πå';
                    errorBox.classList.remove('hidden');
                    scoreData = null;
                    return;
                }
                scoreZone.classList.add('has-file');
                document.getElementById('scoreName').innerHTML = `<span class="filename">${file.name}</span>`;
                document.getElementById('scoreInfo').textContent = `‡∏û‡∏ö ${scoreData.rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                document.getElementById('btnNext2').disabled = false;

                // Populate score column select
                const sel = document.getElementById('scoreColSelect');
                sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å column --</option>';
                scoreData.headers.forEach((h, i) => {
                    if (h) sel.innerHTML += `<option value="${i}">${h}</option>`;
                });
                // Auto-select if has score/‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                const autoIdx = headers.findIndex(h => h.includes('score') || h.includes('‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô') || h.includes('point'));
                if (autoIdx >= 0) sel.value = autoIdx;
            } catch (err) {
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ: ' + err.message);
            }
        });

        // Navigation
        document.getElementById('btnNext1').onclick = () => { currentStep = 2; updateSteps(); };
        document.getElementById('btnBack2').onclick = () => { currentStep = 1; updateSteps(); };
        document.getElementById('btnNext2').onclick = () => {
            currentStep = 3;
            updateSteps();
            // Populate assignment select
            const sel = document.getElementById('assignmentSelect');
            sel.innerHTML = assignments.map(a => `<option value="${a.index}">${a.name}</option>`).join('');
        };
        document.getElementById('btnBack3').onclick = () => { currentStep = 2; updateSteps(); };

        // Mode selection
        document.getElementById('modeScore').onclick = function() {
            mappingMode = 'score';
            this.classList.add('selected');
            document.getElementById('modeAttend').classList.remove('selected');
            document.getElementById('scoreColGroup').classList.remove('hidden');
            document.getElementById('attendScoreGroup').classList.add('hidden');
        };
        document.getElementById('modeAttend').onclick = function() {
            mappingMode = 'attendance';
            this.classList.add('selected');
            document.getElementById('modeScore').classList.remove('selected');
            document.getElementById('scoreColGroup').classList.add('hidden');
            document.getElementById('attendScoreGroup').classList.remove('hidden');
        };

        // Perform mapping
        document.getElementById('btnMap').onclick = () => {
            const assignmentIdx = parseInt(document.getElementById('assignmentSelect').value);
            const scoreColIdx = parseInt(document.getElementById('scoreColSelect').value);
            const attendScore = parseFloat(document.getElementById('attendScore').value) || 0;

            if (mappingMode === 'score' && isNaN(scoreColIdx)) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Column ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô');
                return;
            }

            const canvasHeaders = canvasData.headers.map(h => h.toLowerCase());
            const scoreHeaders = scoreData.headers.map(h => h.toLowerCase());

            // Find columns
            const cIdIdx = canvasHeaders.findIndex(h => h === 'id');
            const cSisIdx = canvasHeaders.findIndex(h => h === 'sis user id' || h === 'sis login id');
            const cEmailIdx = canvasHeaders.findIndex(h => h.includes('email') || h === 'sis login id');

            const sIdIdx = scoreHeaders.findIndex(h => h === 'id' || h === 'student id' || h === 'sis user id');
            const sEmailIdx = scoreHeaders.findIndex(h => h.includes('email') || h === 'sis login id');

            const results = [];
            const startRow = canvasData.rows[0]?.[0]?.toLowerCase().includes('point') ? 1 : 0;

            canvasData.rows.slice(startRow).forEach((cRow, ri) => {
                const name = cRow[0] || '';
                const cId = cRow[cIdIdx] || '';
                const cSis = cRow[cSisIdx] || '';
                const cEmail = cRow[cEmailIdx] || '';

                let newScore = null, matchedBy = '';

                for (const sRow of scoreData.rows) {
                    const sId = sRow[sIdIdx] || '';
                    const sEmail = sRow[sEmailIdx] || '';

                    // Priority: Email > ID
                    if (sEmail && cEmail && sEmail.toLowerCase() === cEmail.toLowerCase()) {
                        matchedBy = 'email';
                        newScore = mappingMode === 'score' ? sRow[scoreColIdx] : attendScore;
                        break;
                    } else if (sId && (cId === sId || cSis === sId)) {
                        matchedBy = 'id';
                        newScore = mappingMode === 'score' ? sRow[scoreColIdx] : attendScore;
                        break;
                    }
                }

                results.push({
                    rowIndex: ri + startRow,
                    name, id: cId || cSis, email: cEmail,
                    oldScore: cRow[assignmentIdx] || '',
                    newScore, matchedBy,
                    status: newScore !== null ? 'matched' : 'not_found'
                });
            });

            mappingResult = { assignmentIdx, results };

            // Update UI
            document.getElementById('statTotal').textContent = results.length;
            document.getElementById('statMatched').textContent = results.filter(r => r.status === 'matched').length;
            document.getElementById('statNotFound').textContent = results.filter(r => r.status === 'not_found').length;

            const tbody = document.getElementById('resultBody');
            tbody.innerHTML = results.map(r => `
                <tr>
                    <td>${r.name}</td>
                    <td>${r.id}</td>
                    <td style="font-size:0.8rem">${r.email}</td>
                    <td>${r.oldScore || '-'}</td>
                    <td style="font-weight:600">${r.newScore !== null ? r.newScore : '-'}</td>
                    <td class="${r.status === 'matched' ? 'matched' : 'not-found'}">
                        ${r.status === 'matched' ? '‚úÖ ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö'}
                    </td>
                </tr>
            `).join('');

            currentStep = 4;
            updateSteps();
        };

        // Export CSV - ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ column A-F ‡πÅ‡∏•‡∏∞ Assignment ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        document.getElementById('btnExport').onclick = () => {
            if (!mappingResult) return;
            
            const assignmentIdx = mappingResult.assignmentIdx;
            const assignmentName = canvasData.headers[assignmentIdx];
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á headers: A-F (index 0-5) + Assignment ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const exportHeaders = [
                ...canvasData.headers.slice(0, 6),
                assignmentName
            ];
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á rows
            const exportRows = [];
            const startRow = canvasData.rows[0]?.[0]?.toLowerCase().includes('point') ? 0 : -1;
            
            canvasData.rows.forEach((row, ri) => {
                const newRow = [
                    ...row.slice(0, 6),
                    ''
                ];
                
                // ‡∏´‡∏≤ result ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö row ‡∏ô‡∏µ‡πâ
                const result = mappingResult.results.find(r => r.rowIndex === ri);
                if (result && result.newScore !== null) {
                    newRow[6] = result.newScore;
                } else {
                    newRow[6] = row[assignmentIdx] || '';
                }
                
                exportRows.push(newRow);
            });

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á CSV
            const escapeCSV = (val) => {
                const v = String(val || '');
                return v.includes(',') || v.includes('"') || v.includes('\n') ? `"${v.replace(/"/g, '""')}"` : v;
            };
            
            let csv = exportHeaders.map(escapeCSV).join(',') + '\n';
            exportRows.forEach(row => {
                csv += row.map(escapeCSV).join(',') + '\n';
            });

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `canvas_grades_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // Reset
        document.getElementById('btnReset').onclick = () => {
            canvasData = scoreData = mappingResult = null;
            assignments = [];
            currentStep = 1;
            canvasZone.classList.remove('has-file');
            scoreZone.classList.remove('has-file');
            document.getElementById('canvasName').textContent = '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á';
            document.getElementById('canvasInfo').textContent = '‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .csv, .xlsx';
            document.getElementById('scoreName').textContent = '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô';
            document.getElementById('scoreInfo').textContent = '‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .csv, .xlsx';
            document.getElementById('btnNext1').disabled = true;
            document.getElementById('btnNext2').disabled = true;
            canvasFileEl.value = '';
            scoreFileEl.value = '';
            updateSteps();
        };

        // ==========================================
        // Student Status Check Mode
        // ==========================================
        let appMode = 'map'; // 'map' or 'check'
        let chkCanvasData = null;
        let registrarFiles = []; // { filename, courseCode, lecSection, labSection, data: {headers, rows} }
        let chkCurrentStep = 1;
        let chkResults = null; // { sections: [...], allEntries: [...] }
        let chkCurrentFilter = 'all';

        function switchMode(mode) {
            appMode = mode;
            document.getElementById('modeMapBtn').classList.toggle('active', mode === 'map');
            document.getElementById('modeCheckBtn').classList.toggle('active', mode === 'check');
            document.getElementById('mapMode').classList.toggle('hidden', mode !== 'map');
            document.getElementById('checkMode').classList.toggle('hidden', mode !== 'check');
            if (mode === 'check') updateChkSteps();
        }

        function updateChkSteps() {
            for (let i = 1; i <= 3; i++) {
                const dot = document.getElementById('chkDot' + i);
                const card = document.getElementById('chkStep' + i);
                dot.classList.remove('active', 'done');
                card.classList.add('hidden');
                if (i < chkCurrentStep) dot.classList.add('done');
                if (i === chkCurrentStep) { dot.classList.add('active'); card.classList.remove('hidden'); }
            }
        }

        // Parse registrar filename: e.g. "261111802000.csv" -> { courseCode: "261111", lecSection: "802", labSection: "000" }
        function parseRegFilename(filename) {
            const base = filename.replace(/\.[^.]+$/, ''); // remove extension
            const match = base.match(/(\d{6})(\d{3})(\d{3})$/);
            if (match) {
                return { courseCode: match[1], lecSection: match[2], labSection: match[3] };
            }
            return null;
        }

        // Check Canvas file upload
        document.getElementById('chkCanvasFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const previewEl = document.getElementById('chkCanvasPreview');
            const errorEl = document.getElementById('chkCanvasError');
            previewEl.classList.add('hidden');
            errorEl.classList.add('hidden');

            try {
                chkCanvasData = await parseFile(file);
                const headers = chkCanvasData.headers.map(h => (h || '').toLowerCase());
                const isCanvasFile = headers[0] === 'student' &&
                                    (headers[1] === 'id' || headers[2]?.includes('sis'));

                if (!isCanvasFile) {
                    errorEl.innerHTML = '‚ö†Ô∏è ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÑ‡∏ü‡∏•‡πå Grade ‡∏à‡∏≤‡∏Å Canvas<br><small>‡πÑ‡∏ü‡∏•‡πå Canvas ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ columns: Student, ID, SIS User ID, ...</small>';
                    errorEl.classList.remove('hidden');
                    document.getElementById('chkCanvasZone').classList.remove('has-file');
                    document.getElementById('chkBtnNext1').disabled = true;
                    return;
                }

                // Count students (skip Points row if exists)
                const startRow = chkCanvasData.rows[0]?.[0]?.toLowerCase().includes('point') ? 1 : 0;
                const studentCount = chkCanvasData.rows.length - startRow;

                // Find section info from Canvas
                const sectionIdx = headers.findIndex(h => h === 'section');
                const sections = new Set();
                if (sectionIdx >= 0) {
                    chkCanvasData.rows.slice(startRow).forEach(row => {
                        if (row[sectionIdx]) sections.add(row[sectionIdx]);
                    });
                }

                previewEl.innerHTML = `
                    <div style="color:#4fd1c5; margin-bottom:0.5rem;">‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Canvas:</div>
                    <div>üë• ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤: ${studentCount} ‡∏Ñ‡∏ô</div>
                    ${sections.size > 0 ? `<div>üìã Sections: ${[...sections].join(', ')}</div>` : ''}
                `;
                previewEl.classList.remove('hidden');

                document.getElementById('chkCanvasZone').classList.add('has-file');
                document.getElementById('chkCanvasName').innerHTML = `<span class="filename">${file.name}</span>`;
                document.getElementById('chkCanvasInfo').textContent = `‡∏û‡∏ö ${studentCount} ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤`;
                document.getElementById('chkBtnNext1').disabled = false;
            } catch (err) {
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ: ' + err.message);
            }
        });

        // Registrar files upload
        document.getElementById('regFiles').addEventListener('change', async (e) => {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            const errorEl = document.getElementById('regError');
            errorEl.classList.add('hidden');

            const newFiles = [];
            const errors = [];

            for (const file of files) {
                const sectionInfo = parseRegFilename(file.name);
                if (!sectionInfo) {
                    errors.push(`${file.name}: ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤6‡∏ï‡∏±‡∏ß + lecSection3‡∏ï‡∏±‡∏ß + labSection3‡∏ï‡∏±‡∏ß)`);
                    continue;
                }

                try {
                    const data = await parseFile(file);
                    // Validate registrar file has ID column
                    const headers = data.headers.map(h => (h || '').toLowerCase().trim());
                    const hasId = headers.some(h => h === 'id');
                    if (!hasId) {
                        errors.push(`${file.name}: ‡πÑ‡∏°‡πà‡∏û‡∏ö column ID ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå`);
                        continue;
                    }

                    // Check for duplicate
                    const key = sectionInfo.courseCode + sectionInfo.lecSection + sectionInfo.labSection;
                    const existing = registrarFiles.findIndex(f =>
                        f.courseCode + f.lecSection + f.labSection === key);
                    if (existing >= 0) {
                        registrarFiles.splice(existing, 1); // replace
                    }

                    newFiles.push({
                        filename: file.name,
                        courseCode: sectionInfo.courseCode,
                        lecSection: sectionInfo.lecSection,
                        labSection: sectionInfo.labSection,
                        data: data
                    });
                } catch (err) {
                    errors.push(`${file.name}: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ - ${err.message}`);
                }
            }

            registrarFiles = registrarFiles.concat(newFiles);

            if (errors.length > 0) {
                errorEl.innerHTML = errors.map(err => '‚ö†Ô∏è ' + err).join('<br>');
                errorEl.classList.remove('hidden');
            }

            updateRegFileList();
            document.getElementById('chkBtnCompare').disabled = registrarFiles.length === 0;
            if (registrarFiles.length > 0) {
                document.getElementById('regZone').classList.add('has-file');
                document.getElementById('regName').innerHTML = `<span class="filename">${registrarFiles.length} ‡πÑ‡∏ü‡∏•‡πå</span>`;
                document.getElementById('regInfo').textContent = `‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå`;
            }
        });

        function updateRegFileList() {
            const listEl = document.getElementById('regFileList');
            if (registrarFiles.length === 0) {
                listEl.innerHTML = '';
                return;
            }
            listEl.innerHTML = registrarFiles.map((f, idx) => `
                <div class="file-item">
                    <div>
                        <span class="file-section">‡∏ß‡∏¥‡∏ä‡∏≤ ${f.courseCode} | Lec ${f.lecSection} | Lab ${f.labSection}</span>
                        <span style="color:#a0aec0; margin-left:0.5rem;">(${f.data.rows.length} ‡∏Ñ‡∏ô)</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:0.75rem;">
                        <span style="color:#a0aec0; font-size:0.8rem;">${f.filename}</span>
                        <span class="file-remove" onclick="removeRegFile(${idx})">‚úï ‡∏•‡∏ö</span>
                    </div>
                </div>
            `).join('');
        }

        function removeRegFile(idx) {
            registrarFiles.splice(idx, 1);
            updateRegFileList();
            document.getElementById('chkBtnCompare').disabled = registrarFiles.length === 0;
            if (registrarFiles.length === 0) {
                document.getElementById('regZone').classList.remove('has-file');
                document.getElementById('regName').textContent = '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)';
                document.getElementById('regInfo').textContent = '‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .csv, .xlsx - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô';
            }
        }

        // Check navigation
        document.getElementById('chkBtnNext1').onclick = () => { chkCurrentStep = 2; updateChkSteps(); };
        document.getElementById('chkBtnBack2').onclick = () => { chkCurrentStep = 1; updateChkSteps(); };

        // Perform comparison
        document.getElementById('chkBtnCompare').onclick = () => {
            if (!chkCanvasData || registrarFiles.length === 0) return;

            const canvasHeaders = chkCanvasData.headers.map(h => (h || '').toLowerCase());
            const startRow = chkCanvasData.rows[0]?.[0]?.toLowerCase().includes('point') ? 1 : 0;

            // Get Canvas student info
            const cSisIdx = canvasHeaders.findIndex(h => h === 'sis user id');
            const cIdIdx = canvasHeaders.findIndex(h => h === 'id');
            const cSectionIdx = canvasHeaders.findIndex(h => h === 'section');

            const canvasStudents = chkCanvasData.rows.slice(startRow).map(row => ({
                name: row[0] || '',
                canvasId: row[cIdIdx] || '',
                sisId: (row[cSisIdx] || '').trim(),
                section: row[cSectionIdx] || '',
                row: row
            })).filter(s => s.name && s.name.toLowerCase() !== 'test student');

            // Build registrar lookup per section
            const allEntries = [];
            const sectionResults = [];

            registrarFiles.forEach(regFile => {
                const regHeaders = regFile.data.headers.map(h => (h || '').toLowerCase().trim());
                const regIdIdx = regHeaders.findIndex(h => h === 'id');
                const regNameIdx = regHeaders.findIndex(h => h === 'name');
                const regSnameIdx = regHeaders.findIndex(h => h === 'sname');
                const regFacIdIdx = regHeaders.findIndex(h => h === 'facid');
                const regFacNameIdx = regHeaders.findIndex(h => h === 'facname');

                const sectionLabel = `‡∏ß‡∏¥‡∏ä‡∏≤ ${regFile.courseCode} | Lec ${regFile.lecSection} | Lab ${regFile.labSection}`;

                // Build set of registrar IDs
                const regStudents = regFile.data.rows.map(row => ({
                    id: (row[regIdIdx] || '').trim(),
                    name: row[regNameIdx] || '',
                    sname: row[regSnameIdx] || '',
                    facId: regFacIdIdx >= 0 ? (row[regFacIdIdx] || '') : '',
                    facName: regFacNameIdx >= 0 ? (row[regFacNameIdx] || '') : ''
                })).filter(s => s.id);

                const regIdSet = new Set(regStudents.map(s => s.id));
                const canvasIdSet = new Set();

                const matched = [];
                const canvasOnly = [];
                const regOnly = [];

                // Check each Canvas student against this registrar section
                canvasStudents.forEach(cs => {
                    const csId = cs.sisId;
                    if (!csId) return;
                    if (regIdSet.has(csId)) {
                        canvasIdSet.add(csId);
                        const regStudent = regStudents.find(r => r.id === csId);
                        matched.push({
                            id: csId,
                            canvasName: cs.name,
                            regName: regStudent ? `${regStudent.name} ${regStudent.sname}` : '',
                            canvasSection: cs.section,
                            facName: regStudent?.facName || '',
                            status: 'match',
                            section: sectionLabel
                        });
                    }
                });

                // Registrar students not in Canvas
                regStudents.forEach(rs => {
                    const inCanvas = canvasStudents.some(cs => cs.sisId === rs.id);
                    if (!inCanvas) {
                        regOnly.push({
                            id: rs.id,
                            canvasName: '-',
                            regName: `${rs.name} ${rs.sname}`,
                            canvasSection: '-',
                            facName: rs.facName,
                            status: 'reg-only',
                            section: sectionLabel
                        });
                    }
                });

                sectionResults.push({
                    label: sectionLabel,
                    filename: regFile.filename,
                    courseCode: regFile.courseCode,
                    lecSection: regFile.lecSection,
                    labSection: regFile.labSection,
                    matched, canvasOnly, regOnly,
                    regTotal: regStudents.length
                });

                allEntries.push(...matched, ...regOnly);
            });

            // Now find Canvas students not in ANY registrar file
            const allRegIds = new Set();
            registrarFiles.forEach(rf => {
                const regHeaders = rf.data.headers.map(h => (h || '').toLowerCase().trim());
                const regIdIdx = regHeaders.findIndex(h => h === 'id');
                rf.data.rows.forEach(row => {
                    const id = (row[regIdIdx] || '').trim();
                    if (id) allRegIds.add(id);
                });
            });

            const canvasOnlyStudents = canvasStudents
                .filter(cs => cs.sisId && !allRegIds.has(cs.sisId))
                .map(cs => ({
                    id: cs.sisId,
                    canvasName: cs.name,
                    regName: '-',
                    canvasSection: cs.section,
                    facName: '-',
                    status: 'canvas-only',
                    section: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'
                }));

            allEntries.push(...canvasOnlyStudents);

            const totalMatched = allEntries.filter(e => e.status === 'match').length;
            const totalCanvasOnly = canvasOnlyStudents.length;
            const totalRegOnly = allEntries.filter(e => e.status === 'reg-only').length;

            chkResults = {
                sections: sectionResults,
                allEntries,
                canvasOnlyStudents,
                canvasTotal: canvasStudents.length,
                regTotal: registrarFiles.reduce((sum, f) => sum + f.data.rows.filter(r => r.some(c => c)).length, 0),
                totalMatched,
                totalIssues: totalCanvasOnly + totalRegOnly
            };

            // Update stats
            document.getElementById('chkStatCanvas').textContent = canvasStudents.length;
            document.getElementById('chkStatReg').textContent = chkResults.regTotal;
            document.getElementById('chkStatMatch').textContent = totalMatched;
            document.getElementById('chkStatIssue').textContent = chkResults.totalIssues;

            // Render results
            chkCurrentFilter = 'all';
            renderCheckResults();

            chkCurrentStep = 3;
            updateChkSteps();
        };

        function filterCheckResults(filter) {
            chkCurrentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderCheckResults();
        }

        function renderCheckResults() {
            if (!chkResults) return;
            const container = document.getElementById('chkResultsContainer');
            let entries = chkResults.allEntries;

            if (chkCurrentFilter !== 'all') {
                entries = entries.filter(e => e.status === chkCurrentFilter);
            }

            // Group by section
            const grouped = {};
            entries.forEach(e => {
                if (!grouped[e.section]) grouped[e.section] = [];
                grouped[e.section].push(e);
            });

            let html = '';
            for (const [section, items] of Object.entries(grouped)) {
                const matchCount = items.filter(i => i.status === 'match').length;
                const canvasOnlyCount = items.filter(i => i.status === 'canvas-only').length;
                const regOnlyCount = items.filter(i => i.status === 'reg-only').length;

                html += `<div class="section-group">`;
                html += `<div class="section-header">
                    üìã ${section}
                    <span class="badge badge-green">${matchCount} ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</span>
                    ${canvasOnlyCount > 0 ? `<span class="badge badge-yellow">${canvasOnlyCount} ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Canvas</span>` : ''}
                    ${regOnlyCount > 0 ? `<span class="badge badge-red">${regOnlyCount} ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</span>` : ''}
                </div>`;
                html += `<div class="table-wrap"><table>
                    <thead><tr>
                        <th>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
                        <th>‡∏ä‡∏∑‡πà‡∏≠ (Canvas)</th>
                        <th>‡∏ä‡∏∑‡πà‡∏≠ (‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)</th>
                        <th>Section (Canvas)</th>
                        <th>‡∏Ñ‡∏ì‡∏∞</th>
                        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    </tr></thead><tbody>`;

                items.forEach(item => {
                    let statusHtml = '';
                    if (item.status === 'match') {
                        statusHtml = '<span class="matched">‚úÖ ‡∏õ‡∏Å‡∏ï‡∏¥</span>';
                    } else if (item.status === 'canvas-only') {
                        statusHtml = '<span class="not-found">‚ö†Ô∏è ‡∏°‡∏µ‡πÉ‡∏ô Canvas ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</span>';
                    } else if (item.status === 'reg-only') {
                        statusHtml = '<span class="not-found">‚ùå ‡∏°‡∏µ‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô Canvas</span>';
                    }
                    html += `<tr>
                        <td>${item.id}</td>
                        <td>${item.canvasName}</td>
                        <td>${item.regName}</td>
                        <td>${item.canvasSection}</td>
                        <td>${item.facName}</td>
                        <td>${statusHtml}</td>
                    </tr>`;
                });

                html += `</tbody></table></div></div>`;
            }

            if (entries.length === 0) {
                html = '<div style="text-align:center; color:#a0aec0; padding:2rem;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>';
            }

            container.innerHTML = html;
        }

        // Export check results
        document.getElementById('chkBtnExport').onclick = () => {
            if (!chkResults) return;

            const escapeCSV = (val) => {
                const v = String(val || '');
                return v.includes(',') || v.includes('"') || v.includes('\n') ? `"${v.replace(/"/g, '""')}"` : v;
            };

            const headers = ['‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤', '‡∏ä‡∏∑‡πà‡∏≠ (Canvas)', '‡∏ä‡∏∑‡πà‡∏≠ (‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)', 'Section (Canvas)', '‡∏Ñ‡∏ì‡∏∞', 'Section (‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'];
            let csv = headers.map(escapeCSV).join(',') + '\n';

            chkResults.allEntries.forEach(item => {
                let statusText = '';
                if (item.status === 'match') statusText = '‡∏õ‡∏Å‡∏ï‡∏¥';
                else if (item.status === 'canvas-only') statusText = '‡∏°‡∏µ‡πÉ‡∏ô Canvas ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
                else if (item.status === 'reg-only') statusText = '‡∏°‡∏µ‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô Canvas';

                csv += [item.id, item.canvasName, item.regName, item.canvasSection, item.facName, item.section, statusText]
                    .map(escapeCSV).join(',') + '\n';
            });

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `student_status_check_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // Check mode reset
        document.getElementById('chkBtnReset').onclick = () => {
            chkCanvasData = null;
            registrarFiles = [];
            chkResults = null;
            chkCurrentStep = 1;
            document.getElementById('chkCanvasZone').classList.remove('has-file');
            document.getElementById('chkCanvasName').textContent = '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á';
            document.getElementById('chkCanvasInfo').textContent = '‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .csv, .xlsx';
            document.getElementById('regZone').classList.remove('has-file');
            document.getElementById('regName').textContent = '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)';
            document.getElementById('regInfo').textContent = '‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .csv, .xlsx - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô';
            document.getElementById('regFileList').innerHTML = '';
            document.getElementById('chkCanvasFile').value = '';
            document.getElementById('regFiles').value = '';
            document.getElementById('chkBtnNext1').disabled = true;
            document.getElementById('chkBtnCompare').disabled = true;
            document.getElementById('chkCanvasPreview').classList.add('hidden');
            document.getElementById('chkCanvasError').classList.add('hidden');
            document.getElementById('regError').classList.add('hidden');
            updateChkSteps();
        };

        // Init
        updateSteps();
    </script>
</body>
</html>
