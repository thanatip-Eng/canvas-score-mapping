<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Grade Mapper & Student Status Check</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --color-bg-primary: #1a1a2e;
            --color-bg-secondary: #16213e;
            --color-bg-tertiary: #0f3460;
            --color-accent: #4fd1c5;
            --color-accent-dark: #38b2ac;
            --color-accent-rgb: 79, 209, 197;
            --color-success: #48bb78;
            --color-success-rgb: 72, 187, 120;
            --color-danger: #fc8181;
            --color-danger-dark: #f56565;
            --color-danger-rgb: 252, 129, 129;
            --color-warning: #ecc94b;
            --color-warning-rgb: 236, 201, 75;
            --color-info: #63b3ed;
            --color-info-rgb: 99, 179, 237;
            --color-text-primary: #e4e4e7;
            --color-text-muted: #a0aec0;
            --color-text-footer: #64748b;
            --color-surface: rgba(255, 255, 255, 0.05);
            --color-surface-hover: rgba(255, 255, 255, 0.08);
            --color-surface-active: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.1);
            --color-border-light: rgba(255, 255, 255, 0.15);
            --color-border-medium: rgba(255, 255, 255, 0.2);
            --radius-sm: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --transition-default: all 0.3s ease;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--color-bg-primary) 0%, var(--color-bg-secondary) 50%, var(--color-bg-tertiary) 100%);
            font-family: 'Sarabun', 'Segoe UI', sans-serif;
            color: var(--color-text-primary);
            padding: 1.5rem;
        }
        .container { max-width: 1100px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 2.5rem; }
        h1 {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--color-accent), var(--color-info));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        .subtitle { color: var(--color-text-muted); font-size: 1rem; }
        .card {
            background: var(--color-surface);
            backdrop-filter: blur(10px);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            margin-bottom: 1.25rem;
            transition: var(--transition-default);
        }
        .card:hover { border-color: rgba(var(--color-accent-rgb), 0.3); }
        .card h2 { font-size: 1.15rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .card p.hint { color: var(--color-text-muted); font-size: 0.85rem; margin-bottom: 1rem; }
        .upload-zone {
            border: 2px dashed rgba(var(--color-accent-rgb), 0.4);
            border-radius: var(--radius-lg);
            padding: 2rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition-default);
            background: rgba(var(--color-accent-rgb), 0.02);
        }
        .upload-zone:hover {
            border-color: var(--color-accent);
            background: rgba(var(--color-accent-rgb), 0.08);
            transform: translateY(-2px);
        }
        .upload-zone.has-file { border-color: var(--color-success); background: rgba(var(--color-success-rgb), 0.1); }
        .upload-zone input { display: none; }
        .upload-zone .icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .upload-zone .filename { font-weight: 600; color: var(--color-success); }
        .upload-zone .info { color: var(--color-text-muted); font-size: 0.85rem; margin-top: 0.25rem; }
        .btn {
            background: linear-gradient(135deg, var(--color-accent), var(--color-accent-dark));
            color: var(--color-bg-primary);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: var(--transition-default);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: inherit;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(var(--color-accent-rgb), 0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: var(--color-surface-active); color: var(--color-text-primary); border: 1px solid var(--color-border-medium); }
        .btn-secondary:hover { background: rgba(255,255,255,0.15); box-shadow: none; }
        select, input[type="number"] {
            background: var(--color-surface-hover);
            border: 1px solid var(--color-border-medium);
            color: var(--color-text-primary);
            padding: 0.7rem 1rem;
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            width: 100%;
            font-family: inherit;
            transition: var(--transition-default);
        }
        select:focus, input:focus { outline: none; border-color: var(--color-accent); box-shadow: 0 0 0 3px rgba(var(--color-accent-rgb), 0.2); }
        label.field { display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.9rem; }
        .form-group { margin-bottom: 1.25rem; }
        .radio-group { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .radio-option {
            background: var(--color-surface);
            border: 2px solid var(--color-border-light);
            border-radius: var(--radius-md);
            padding: 1rem;
            cursor: pointer;
            transition: var(--transition-default);
            flex: 1;
            min-width: 180px;
        }
        .radio-option:hover { border-color: rgba(var(--color-accent-rgb), 0.4); }
        .radio-option.selected { border-color: var(--color-accent); background: rgba(var(--color-accent-rgb), 0.1); }
        .radio-option .title { font-weight: 600; margin-bottom: 0.3rem; }
        .radio-option .desc { font-size: 0.8rem; color: var(--color-text-muted); }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1.5rem; }
        .stat-card { background: var(--color-surface); border-radius: var(--radius-md); padding: 1rem; text-align: center; }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--color-accent); }
        .stat-value.green { color: var(--color-success); }
        .stat-value.red { color: var(--color-danger); }
        .stat-label { color: var(--color-text-muted); font-size: 0.8rem; margin-top: 0.25rem; }
        .table-wrap { overflow-x: auto; margin-top: 1rem; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 0.7rem 0.6rem; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.08); }
        th { background: rgba(var(--color-accent-rgb), 0.1); font-weight: 600; color: var(--color-accent); white-space: nowrap; }
        tr:hover { background: rgba(255,255,255,0.03); }
        .matched { color: var(--color-success); }
        .not-found { color: var(--color-danger); }
        .error-msg { background: rgba(var(--color-danger-rgb), 0.15); border: 1px solid rgba(var(--color-danger-rgb), 0.3); color: var(--color-danger); padding: 0.75rem 1rem; border-radius: var(--radius-sm); margin: 0.75rem 0; font-size: 0.9rem; }
        .step-nav { display: flex; justify-content: center; gap: 0.75rem; margin-bottom: 1.5rem; }
        .step-dot {
            width: 36px; height: 36px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 0.9rem;
            background: var(--color-surface-active);
            border: 2px solid var(--color-border-medium);
            transition: var(--transition-default);
        }
        .step-dot.active { background: var(--color-accent); color: var(--color-bg-primary); border-color: var(--color-accent); }
        .step-dot.done { background: var(--color-success); color: var(--color-bg-primary); border-color: var(--color-success); }
        .hidden { display: none !important; }
        .actions { margin-top: 1.5rem; display: flex; gap: 0.75rem; flex-wrap: wrap; }
        footer { text-align: center; margin-top: 2rem; color: var(--color-text-footer); font-size: 0.85rem; }
        /* Mode selector */
        .mode-selector { display: flex; gap: 0.75rem; justify-content: center; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .mode-btn {
            background: var(--color-surface);
            border: 2px solid var(--color-border-light);
            border-radius: var(--radius-lg);
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: var(--transition-default);
            text-align: center;
            color: var(--color-text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            min-width: 220px;
        }
        .mode-btn:hover { border-color: rgba(var(--color-accent-rgb), 0.4); background: rgba(var(--color-accent-rgb), 0.05); }
        .mode-btn.active { border-color: var(--color-accent); background: rgba(var(--color-accent-rgb), 0.12); }
        .mode-btn .mode-icon { font-size: 1.5rem; margin-bottom: 0.3rem; }
        .mode-btn .mode-title { font-weight: 600; }
        .mode-btn .mode-desc { font-size: 0.8rem; color: var(--color-text-muted); margin-top: 0.2rem; }
        /* Status check specific */
        .file-list { margin-top: 0.75rem; }
        .file-item {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--color-surface); border-radius: var(--radius-sm);
            padding: 0.5rem 0.75rem; margin-bottom: 0.4rem; font-size: 0.85rem;
        }
        .file-item .file-section { color: var(--color-accent); font-weight: 600; }
        .file-item .file-remove { cursor: pointer; color: var(--color-danger); font-size: 0.8rem; }
        .file-item .file-remove:hover { color: var(--color-danger-dark); }
        .stats-grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 1.5rem; }
        .badge { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
        .badge-green { background: rgba(var(--color-success-rgb), 0.2); color: var(--color-success); }
        .badge-red { background: rgba(var(--color-danger-rgb), 0.2); color: var(--color-danger); }
        .badge-yellow { background: rgba(var(--color-warning-rgb), 0.2); color: var(--color-warning); }
        .badge-blue { background: rgba(var(--color-info-rgb), 0.2); color: var(--color-info); }
        .section-group { margin-bottom: 1.5rem; }
        .section-header {
            font-weight: 600; font-size: 1rem; margin-bottom: 0.5rem;
            padding: 0.5rem 0.75rem; background: rgba(var(--color-accent-rgb), 0.1);
            border-radius: var(--radius-sm); display: flex; align-items: center; gap: 0.5rem;
        }
        .filter-bar { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .filter-btn {
            background: var(--color-surface-hover); border: 1px solid var(--color-border-light);
            color: var(--color-text-primary); padding: 0.4rem 0.8rem; border-radius: var(--radius-sm);
            cursor: pointer; font-size: 0.85rem; font-family: inherit; transition: all 0.2s;
        }
        .filter-btn:hover { border-color: rgba(var(--color-accent-rgb), 0.4); }
        .filter-btn.active { border-color: var(--color-accent); background: rgba(var(--color-accent-rgb), 0.15); color: var(--color-accent); }
        /* Utility classes */
        .hint-box { background: rgba(var(--color-accent-rgb), 0.1); padding: 0.75rem; border-radius: var(--radius-sm); margin-bottom: 1rem; font-size: 0.8rem; }
        .preview-box { margin-top: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: var(--radius-sm); font-size: 0.8rem; }
        .mt-1 { margin-top: 1rem; }
        .ml-half { margin-left: 0.5rem; }
        .text-accent { color: var(--color-accent); }
        .text-muted { color: var(--color-text-muted); }
        .text-small { font-size: 0.8rem; }
        .text-bold { font-weight: 600; }
        .input-narrow { max-width: 150px; }
        .empty-state { text-align: center; color: var(--color-text-muted); padding: 2rem; }
        /* Toast notification */
        .toast {
            position: fixed; top: 1.5rem; right: 1.5rem; z-index: 1000;
            max-width: 400px; animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: 1fr; }
            .stats-grid-4 { grid-template-columns: repeat(2, 1fr); }
            .radio-group { flex-direction: column; }
            .mode-selector { flex-direction: column; align-items: center; }
            h1 { font-size: 1.75rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Canvas Grade Mapper</h1>
            <p class="subtitle">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Canvas LMS</p>
        </header>

        <!-- Mode Selector -->
        <div class="mode-selector">
            <button class="mode-btn active" id="modeMapBtn">
                <div class="mode-icon">üìä</div>
                <div class="mode-title">Map ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                <div class="mode-desc">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤ Canvas</div>
            </button>
            <button class="mode-btn" id="modeCheckBtn">
                <div class="mode-icon">üîç</div>
                <div class="mode-title">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</div>
                <div class="mode-desc">‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Canvas ‡∏Å‡∏±‡∏ö‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
            </button>
        </div>

        <!-- Score Mapping Mode Steps -->
        <div id="mapMode">
        <div class="step-nav">
            <div class="step-dot active" id="mapDot1">1</div>
            <div class="step-dot" id="mapDot2">2</div>
            <div class="step-dot" id="mapDot3">3</div>
            <div class="step-dot" id="mapDot4">4</div>
        </div>

        <!-- Step 1 -->
        <div class="card" id="mapStep1">
            <h2>1Ô∏è‚É£ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Grade ‡∏à‡∏≤‡∏Å Canvas</h2>
            <p class="hint">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Grades ‡∏à‡∏≤‡∏Å Canvas (Gradebook > Export) ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö CSV ‡∏´‡∏£‡∏∑‡∏≠ Excel</p>
            <div class="hint hint-box">
                üìå ‡πÑ‡∏ü‡∏•‡πå Canvas ‡∏à‡∏∞‡∏°‡∏µ columns: Student, ID, SIS User ID, SIS Login ID, Integration ID, Section, ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢ Assignments
            </div>
            <label class="upload-zone" id="canvasZone">
                <input type="file" id="canvasFile" accept=".csv,.xlsx,.xls" aria-label="‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Canvas Grade">
                <div class="icon">üìÅ</div>
                <div id="canvasName">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á</div>
                <div class="info" id="canvasInfo">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .csv, .xlsx</div>
            </label>
            <div id="canvasPreview" class="hidden preview-box"></div>
            <div id="canvasError" class="error-msg hidden" role="alert"></div>
            <div class="mt-1">
                <button class="btn" id="btnNext1" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
            </div>
        </div>

        <!-- Step 2 -->
        <div class="card hidden" id="mapStep2">
            <h2>2Ô∏è‚É£ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
            <p class="hint">‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ID ‡∏´‡∏£‡∏∑‡∏≠ Email (‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á) - ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏à‡∏∞‡πÉ‡∏ä‡πâ Email ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å</p>
            <div id="errorBox" class="error-msg hidden" role="alert"></div>
            <label class="upload-zone" id="scoreZone">
                <input type="file" id="scoreFile" accept=".csv,.xlsx,.xls" aria-label="‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô">
                <div class="icon">üìä</div>
                <div id="scoreName">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                <div class="info" id="scoreInfo">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .csv, .xlsx</div>
            </label>
            <div class="mt-1">
                <button class="btn btn-secondary" id="btnBack2">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                <button class="btn ml-half" id="btnNext2" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
            </div>
        </div>

        <!-- Step 3 -->
        <div class="card hidden" id="mapStep3">
            <h2>3Ô∏è‚É£ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£ Map ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
            <div class="form-group">
                <label class="field">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Assignment ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤:</label>
                <select id="assignmentSelect"></select>
            </div>
            <div class="form-group">
                <label class="field">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</label>
                <div class="radio-group">
                    <div class="radio-option selected" id="modeScore" data-mode="score">
                        <div class="title">üìù ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å Column</div>
                        <div class="desc">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å column ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå</div>
                    </div>
                    <div class="radio-option" id="modeAttend" data-mode="attendance">
                        <div class="title">‚úÖ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</div>
                        <div class="desc">‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå = ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</div>
                    </div>
                </div>
            </div>
            <div class="form-group" id="scoreColGroup">
                <label class="field">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Column ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</label>
                <select id="scoreColSelect"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å column --</option></select>
            </div>
            <div class="form-group hidden" id="attendScoreGroup">
                <label class="field">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏´‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£):</label>
                <input type="number" id="attendScore" value="1" min="0" step="0.1" class="input-narrow">
            </div>
            <div>
                <button class="btn btn-secondary" id="btnBack3">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                <button class="btn ml-half" id="btnMap">üîÑ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ Map ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            </div>
        </div>

        <!-- Step 4 -->
        <div class="card hidden" id="mapStep4">
            <h2>4Ô∏è‚É£ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£ Map ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="statTotal">0</div><div class="stat-label">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
                <div class="stat-card"><div class="stat-value green" id="statMatched">0</div><div class="stat-label">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div></div>
                <div class="stat-card"><div class="stat-value red" id="statNotFound">0</div><div class="stat-label">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div></div>
            </div>
            <div class="actions">
                <button class="btn" id="btnExport">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Import Canvas</button>
                <button class="btn btn-secondary" id="btnReset">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
                            <th>ID</th>
                            <th>Email</th>
                            <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏î‡∏¥‡∏°</th>
                            <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡∏°‡πà</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody"></tbody>
                </table>
            </div>
        </div>

        </div><!-- end mapMode -->

        <!-- Student Status Check Mode -->
        <div id="checkMode" class="hidden">
        <div class="step-nav">
            <div class="step-dot active" id="chkDot1">1</div>
            <div class="step-dot" id="chkDot2">2</div>
            <div class="step-dot" id="chkDot3">3</div>
        </div>

        <!-- Check Step 1: Upload Canvas -->
        <div class="card" id="chkStep1">
            <h2>1Ô∏è‚É£ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Grade ‡∏à‡∏≤‡∏Å Canvas</h2>
            <p class="hint">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Grades ‡∏à‡∏≤‡∏Å Canvas (Gradebook > Export) - ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Assignment</p>
            <div class="hint hint-box">
                üìå ‡πÑ‡∏ü‡∏•‡πå Canvas ‡∏à‡∏∞‡∏°‡∏µ columns: Student, ID, SIS User ID, SIS Login ID, Integration ID, Section
            </div>
            <label class="upload-zone" id="chkCanvasZone">
                <input type="file" id="chkCanvasFile" accept=".csv,.xlsx,.xls" aria-label="‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Canvas Grade ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö">
                <div class="icon">üìÅ</div>
                <div id="chkCanvasName">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á</div>
                <div class="info" id="chkCanvasInfo">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .csv, .xlsx</div>
            </label>
            <div id="chkCanvasPreview" class="hidden preview-box"></div>
            <div id="chkCanvasError" class="error-msg hidden" role="alert"></div>
            <div class="mt-1">
                <button class="btn" id="chkBtnNext1" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
            </div>
        </div>

        <!-- Check Step 2: Upload Registrar Files -->
        <div class="card hidden" id="chkStep2">
            <h2>2Ô∏è‚É£ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
            <p class="hint">‡πÑ‡∏ü‡∏•‡πå CSV ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° section - ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå: ‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤(6 ‡∏ï‡∏±‡∏ß) + lecture section(3 ‡∏ï‡∏±‡∏ß) + lab section(3 ‡∏ï‡∏±‡∏ß) ‡πÄ‡∏ä‡πà‡∏ô 261111802000.csv</p>
            <div class="hint hint-box">
                üìå ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢: ID, NAME, SNAME, Column1_1, FACID, FACNAME
            </div>
            <label class="upload-zone" id="regZone">
                <input type="file" id="regFiles" accept=".csv,.xlsx,.xls" multiple aria-label="‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô">
                <div class="icon">üìã</div>
                <div id="regName">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)</div>
                <div class="info" id="regInfo">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .csv, .xlsx - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô</div>
            </label>
            <div id="regFileList" class="file-list"></div>
            <div id="regError" class="error-msg hidden" role="alert"></div>
            <div class="mt-1">
                <button class="btn btn-secondary" id="chkBtnBack2">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                <button class="btn ml-half" id="chkBtnCompare" disabled>üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
            </div>
        </div>

        <!-- Check Step 3: Results -->
        <div class="card hidden" id="chkStep3">
            <h2>3Ô∏è‚É£ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h2>
            <div class="stats-grid-4" id="chkStatsGrid">
                <div class="stat-card"><div class="stat-value" id="chkStatCanvas">0</div><div class="stat-label">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏ô Canvas</div></div>
                <div class="stat-card"><div class="stat-value" id="chkStatReg">0</div><div class="stat-label">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div></div>
                <div class="stat-card"><div class="stat-value green" id="chkStatMatch">0</div><div class="stat-label">‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (‡∏õ‡∏Å‡∏ï‡∏¥)</div></div>
                <div class="stat-card"><div class="stat-value red" id="chkStatIssue">0</div><div class="stat-label">‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</div></div>
            </div>
            <div class="actions">
                <button class="btn" id="chkBtnExport">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ CSV</button>
                <button class="btn btn-secondary" id="chkBtnReset">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
            </div>
            <div class="filter-bar">
                <button class="filter-btn active" data-filter="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button class="filter-btn" data-filter="match">‚úÖ ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</button>
                <button class="filter-btn" data-filter="canvas-only">‚ö†Ô∏è ‡∏°‡∏µ‡πÉ‡∏ô Canvas ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                <button class="filter-btn" data-filter="reg-only">‚ùå ‡∏°‡∏µ‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô Canvas</button>
            </div>
            <div id="chkResultsContainer"></div>
        </div>
        </div><!-- end checkMode -->

        <footer>
            <p>üìå ‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡πÑ‡∏ü‡∏•‡πå CSV ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏ô‡∏≥‡πÑ‡∏õ Import ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ Canvas ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏°‡∏ô‡∏π Grades > Import</p>
        </footer>
    </div>

    <script>
        // ========== CONSTANTS ==========
        const CANVAS_FIXED_COLS = 6;
        const ASSIGNMENT_ID_REGEX = /\(\d+\)/;
        const REGISTRAR_FILENAME_REGEX = /(\d{6})(\d{3})(\d{3})$/;
        const EXCLUDE_PATTERNS = [
            'current point', 'final point', 'current score', 'final score',
            'unposted', 'read only', 'imported assignment'
        ];
        const POINTS_ROW_MARKER = 'point';

        const STATUS = Object.freeze({
            MATCH: 'match',
            MATCHED: 'matched',
            NOT_FOUND: 'not_found',
            CANVAS_ONLY: 'canvas-only',
            REG_ONLY: 'reg-only'
        });

        const STATUS_LABELS = Object.freeze({
            [STATUS.MATCH]: '‚úÖ ‡∏õ‡∏Å‡∏ï‡∏¥',
            [STATUS.MATCHED]: '‚úÖ ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            [STATUS.NOT_FOUND]: '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö',
            [STATUS.CANVAS_ONLY]: '‚ö†Ô∏è ‡∏°‡∏µ‡πÉ‡∏ô Canvas ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô',
            [STATUS.REG_ONLY]: '‚ùå ‡∏°‡∏µ‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô Canvas'
        });

        const STATUS_CSS = Object.freeze({
            [STATUS.MATCH]: 'matched',
            [STATUS.MATCHED]: 'matched',
            [STATUS.NOT_FOUND]: 'not-found',
            [STATUS.CANVAS_ONLY]: 'not-found',
            [STATUS.REG_ONLY]: 'not-found'
        });

        // ========== STATE ==========
        const state = {
            activeMode: 'map',
            map: {
                canvasData: null,
                scoreData: null,
                assignments: [],
                mappingResult: null,
                currentStep: 1,
                mappingMode: 'score'
            },
            check: {
                canvasData: null,
                registrarFiles: [],
                currentStep: 1,
                results: null,
                currentFilter: 'all'
            }
        };

        const MODE_REGISTRY = {
            map: {
                containerId: 'mapMode',
                btnId: 'modeMapBtn',
                totalSteps: 4,
                dotPrefix: 'map'
            },
            check: {
                containerId: 'checkMode',
                btnId: 'modeCheckBtn',
                totalSteps: 3,
                dotPrefix: 'chk'
            }
        };

        // ========== UTILITIES ==========

        // Parse file (CSV or Excel)
        function parseFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                const name = file.name.toLowerCase();

                if (name.endsWith('.csv')) {
                    reader.onload = (e) => {
                        const text = e.target.result;
                        const lines = text.split(/\r?\n/).map(line => {
                            const result = [];
                            let cell = '', inQuotes = false;
                            for (let ch of line) {
                                if (ch === '"') inQuotes = !inQuotes;
                                else if (ch === ',' && !inQuotes) { result.push(cell.trim()); cell = ''; }
                                else cell += ch;
                            }
                            result.push(cell.trim());
                            return result;
                        });
                        resolve({ headers: lines[0] || [], rows: lines.slice(1).filter(r => r.some(c => c)) });
                    };
                    reader.onerror = reject;
                    reader.readAsText(file, 'UTF-8');
                } else {
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const wb = XLSX.read(data, { type: 'array' });
                        const sheet = wb.Sheets[wb.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        resolve({ headers: (json[0] || []).map(h => h?.toString() || ''), rows: json.slice(1).map(r => r.map(c => c?.toString() || '')) });
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                }
            });
        }

        function validateCanvasFile(data) {
            const headers = data.headers.map(h => (h || '').toLowerCase());
            return headers[0] === 'student' && (headers[1] === 'id' || headers[2]?.includes('sis'));
        }

        function getPointsRowStart(rows) {
            return rows[0]?.[0]?.toLowerCase().includes(POINTS_ROW_MARKER) ? 1 : 0;
        }

        function escapeCSV(val) {
            const v = String(val || '');
            return v.includes(',') || v.includes('"') || v.includes('\n') ? `"${v.replace(/"/g, '""')}"` : v;
        }

        function downloadCSV(csvContent, filenamePrefix) {
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filenamePrefix}_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function updateStepIndicators(prefix, totalSteps, currentStep) {
            for (let i = 1; i <= totalSteps; i++) {
                const dot = document.getElementById(prefix + 'Dot' + i);
                const card = document.getElementById(prefix + 'Step' + i);
                dot.classList.remove('active', 'done');
                card.classList.add('hidden');
                if (i < currentStep) dot.classList.add('done');
                if (i === currentStep) { dot.classList.add('active'); card.classList.remove('hidden'); }
            }
        }

        function resetUploadZone(zoneId, nameId, nameText, infoId, infoText, fileInputId) {
            document.getElementById(zoneId).classList.remove('has-file');
            document.getElementById(nameId).textContent = nameText;
            document.getElementById(infoId).textContent = infoText;
            document.getElementById(fileInputId).value = '';
        }

        function findColumnIndex(headers, ...terms) {
            const lower = headers.map(h => (h || '').toLowerCase());
            for (const term of terms) {
                const idx = lower.findIndex(h => typeof term === 'function' ? term(h) : h === term);
                if (idx >= 0) return idx;
            }
            return -1;
        }

        function showInlineError(elementId, message) {
            const el = document.getElementById(elementId);
            el.innerHTML = message;
            el.classList.remove('hidden');
        }

        function hideElement(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'error-msg toast';
            toast.textContent = message;
            toast.setAttribute('role', 'alert');
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function extractAssignments(headers) {
            const assignments = [];
            headers.forEach((h, i) => {
                if (i >= CANVAS_FIXED_COLS && h) {
                    const lower = h.toLowerCase();
                    const isExcluded = EXCLUDE_PATTERNS.some(p => lower.includes(p));
                    const hasAssignmentId = ASSIGNMENT_ID_REGEX.test(h);
                    if (!isExcluded && (hasAssignmentId || !lower.includes('point') && !lower.includes('score'))) {
                        assignments.push({ index: i, name: h });
                    }
                }
            });
            return assignments;
        }

        function parseRegFilename(filename) {
            const base = filename.replace(/\.[^.]+$/, '');
            const match = base.match(REGISTRAR_FILENAME_REGEX);
            if (match) {
                return { courseCode: match[1], lecSection: match[2], labSection: match[3] };
            }
            return null;
        }

        // ========== MODE MANAGEMENT ==========

        function switchMode(mode) {
            state.activeMode = mode;
            for (const [key, config] of Object.entries(MODE_REGISTRY)) {
                document.getElementById(config.btnId).classList.toggle('active', key === mode);
                document.getElementById(config.containerId).classList.toggle('hidden', key !== mode);
            }
            const activeConfig = MODE_REGISTRY[mode];
            const modeState = state[mode];
            updateStepIndicators(activeConfig.dotPrefix, activeConfig.totalSteps, modeState.currentStep);
        }

        function updateMapSteps() {
            updateStepIndicators('map', MODE_REGISTRY.map.totalSteps, state.map.currentStep);
        }

        function updateChkSteps() {
            updateStepIndicators('chk', MODE_REGISTRY.check.totalSteps, state.check.currentStep);
        }

        // ========== SCORE MAPPING: Data Processing ==========

        function findCanvasColumnIndices(headers) {
            const lower = headers.map(h => (h || '').toLowerCase());
            return {
                idIdx: lower.findIndex(h => h === 'id'),
                sisIdx: lower.findIndex(h => h === 'sis user id' || h === 'sis login id'),
                emailIdx: lower.findIndex(h => h.includes('email') || h === 'sis login id')
            };
        }

        function findScoreColumnIndices(headers) {
            const lower = headers.map(h => (h || '').toLowerCase());
            return {
                idIdx: lower.findIndex(h => h === 'id' || h === 'student id' || h === 'sis user id'),
                emailIdx: lower.findIndex(h => h.includes('email') || h === 'sis login id')
            };
        }

        function buildScoreLookup(scoreRows, scoreCols) {
            const emailMap = new Map();
            const idMap = new Map();
            scoreRows.forEach(sRow => {
                const email = (sRow[scoreCols.emailIdx] || '').toLowerCase().trim();
                const id = (sRow[scoreCols.idIdx] || '').trim();
                if (email && !emailMap.has(email)) emailMap.set(email, sRow);
                if (id && !idMap.has(id)) idMap.set(id, sRow);
            });
            return { emailMap, idMap };
        }

        function performStudentMatching(canvasData, scoreData, assignmentIdx, mode, scoreColIdx, attendScore) {
            const canvasCols = findCanvasColumnIndices(canvasData.headers);
            const scoreCols = findScoreColumnIndices(scoreData.headers);
            const { emailMap, idMap } = buildScoreLookup(scoreData.rows, scoreCols);

            const startRow = getPointsRowStart(canvasData.rows);

            return canvasData.rows.slice(startRow).map((cRow, ri) => {
                const name = cRow[0] || '';
                const cId = (cRow[canvasCols.idIdx] || '').trim();
                const cSis = (cRow[canvasCols.sisIdx] || '').trim();
                const cEmail = (cRow[canvasCols.emailIdx] || '').toLowerCase().trim();

                let newScore = null, matchedBy = '';

                // Priority: Email > ID (O(1) lookup via Map)
                const emailMatch = cEmail ? emailMap.get(cEmail) : null;
                if (emailMatch) {
                    matchedBy = 'email';
                    newScore = mode === 'score' ? emailMatch[scoreColIdx] : attendScore;
                } else {
                    const idMatch = idMap.get(cId) || idMap.get(cSis);
                    if (idMatch) {
                        matchedBy = 'id';
                        newScore = mode === 'score' ? idMatch[scoreColIdx] : attendScore;
                    }
                }

                return {
                    rowIndex: ri + startRow,
                    name,
                    id: cId || cSis,
                    email: cRow[canvasCols.emailIdx] || '',
                    oldScore: cRow[assignmentIdx] || '',
                    newScore,
                    matchedBy,
                    status: newScore !== null ? STATUS.MATCHED : STATUS.NOT_FOUND
                };
            });
        }

        // ========== SCORE MAPPING: Rendering ==========

        function renderMappingResults(results) {
            document.getElementById('statTotal').textContent = results.length;
            document.getElementById('statMatched').textContent = results.filter(r => r.status === STATUS.MATCHED).length;
            document.getElementById('statNotFound').textContent = results.filter(r => r.status === STATUS.NOT_FOUND).length;

            document.getElementById('resultBody').innerHTML = results.map(r => `
                <tr>
                    <td>${r.name}</td>
                    <td>${r.id}</td>
                    <td class="text-small">${r.email}</td>
                    <td>${r.oldScore || '-'}</td>
                    <td class="text-bold">${r.newScore !== null ? r.newScore : '-'}</td>
                    <td class="${STATUS_CSS[r.status]}">${STATUS_LABELS[r.status]}</td>
                </tr>
            `).join('');
        }

        // ========== SCORE MAPPING: Export ==========

        function exportMappingCSV() {
            const { mappingResult, canvasData } = state.map;
            if (!mappingResult) return;

            const assignmentIdx = mappingResult.assignmentIdx;
            const assignmentName = canvasData.headers[assignmentIdx];

            const exportHeaders = [...canvasData.headers.slice(0, CANVAS_FIXED_COLS), assignmentName];

            // Build O(1) lookup for results by row index
            const resultByRow = new Map(mappingResult.results.map(r => [r.rowIndex, r]));

            const exportRows = canvasData.rows.map((row, ri) => {
                const newRow = [...row.slice(0, CANVAS_FIXED_COLS), ''];
                const result = resultByRow.get(ri);
                newRow[CANVAS_FIXED_COLS] = (result && result.newScore !== null) ? result.newScore : (row[assignmentIdx] || '');
                return newRow;
            });

            let csv = exportHeaders.map(escapeCSV).join(',') + '\n';
            exportRows.forEach(row => {
                csv += row.map(escapeCSV).join(',') + '\n';
            });

            downloadCSV(csv, 'canvas_grades');
        }

        // ========== SCORE MAPPING: Reset ==========

        function resetMapMode() {
            Object.assign(state.map, {
                canvasData: null, scoreData: null, assignments: [],
                mappingResult: null, currentStep: 1, mappingMode: 'score'
            });
            resetUploadZone('canvasZone', 'canvasName', '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á', 'canvasInfo', '‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .csv, .xlsx', 'canvasFile');
            resetUploadZone('scoreZone', 'scoreName', '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô', 'scoreInfo', '‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .csv, .xlsx', 'scoreFile');
            document.getElementById('btnNext1').disabled = true;
            document.getElementById('btnNext2').disabled = true;
            hideElement('canvasPreview');
            hideElement('canvasError');
            updateMapSteps();
        }

        // ========== STUDENT STATUS CHECK: Data Processing ==========

        function extractCanvasStudents(canvasData) {
            const headers = canvasData.headers.map(h => (h || '').toLowerCase());
            const cSisIdx = headers.findIndex(h => h === 'sis user id');
            const cIdIdx = headers.findIndex(h => h === 'id');
            const cSectionIdx = headers.findIndex(h => h === 'section');
            const startRow = getPointsRowStart(canvasData.rows);

            return canvasData.rows.slice(startRow).map(row => ({
                name: row[0] || '',
                canvasId: row[cIdIdx] || '',
                sisId: (row[cSisIdx] || '').trim(),
                section: row[cSectionIdx] || '',
                row
            })).filter(s => s.name && s.name.toLowerCase() !== 'test student');
        }

        function compareSection(canvasStudents, canvasBySisId, regFile) {
            const regHeaders = regFile.data.headers.map(h => (h || '').toLowerCase().trim());
            const regIdIdx = regHeaders.findIndex(h => h === 'id');
            const regNameIdx = regHeaders.findIndex(h => h === 'name');
            const regSnameIdx = regHeaders.findIndex(h => h === 'sname');
            const regFacIdIdx = regHeaders.findIndex(h => h === 'facid');
            const regFacNameIdx = regHeaders.findIndex(h => h === 'facname');

            const sectionLabel = `‡∏ß‡∏¥‡∏ä‡∏≤ ${regFile.courseCode} | Lec ${regFile.lecSection} | Lab ${regFile.labSection}`;

            const regStudents = regFile.data.rows.map(row => ({
                id: (row[regIdIdx] || '').trim(),
                name: row[regNameIdx] || '',
                sname: row[regSnameIdx] || '',
                facId: regFacIdIdx >= 0 ? (row[regFacIdIdx] || '') : '',
                facName: regFacNameIdx >= 0 ? (row[regFacNameIdx] || '') : ''
            })).filter(s => s.id);

            const regIdSet = new Set(regStudents.map(s => s.id));
            // Build registrar lookup Map for O(1) access
            const regById = new Map(regStudents.map(s => [s.id, s]));
            const matched = [];
            const regOnly = [];

            // Check Canvas students against this registrar section
            canvasStudents.forEach(cs => {
                if (!cs.sisId) return;
                if (regIdSet.has(cs.sisId)) {
                    const regStudent = regById.get(cs.sisId);
                    matched.push({
                        id: cs.sisId,
                        canvasName: cs.name,
                        regName: regStudent ? `${regStudent.name} ${regStudent.sname}` : '',
                        canvasSection: cs.section,
                        facName: regStudent?.facName || '',
                        status: STATUS.MATCH,
                        section: sectionLabel
                    });
                }
            });

            // Registrar students not in Canvas (O(1) lookup via Map)
            regStudents.forEach(rs => {
                if (!canvasBySisId.has(rs.id)) {
                    regOnly.push({
                        id: rs.id,
                        canvasName: '-',
                        regName: `${rs.name} ${rs.sname}`,
                        canvasSection: '-',
                        facName: rs.facName,
                        status: STATUS.REG_ONLY,
                        section: sectionLabel
                    });
                }
            });

            return {
                label: sectionLabel,
                filename: regFile.filename,
                courseCode: regFile.courseCode,
                lecSection: regFile.lecSection,
                labSection: regFile.labSection,
                matched,
                canvasOnly: [],
                regOnly,
                regTotal: regStudents.length
            };
        }

        function findCanvasOnlyStudents(canvasStudents, allRegIds) {
            return canvasStudents
                .filter(cs => cs.sisId && !allRegIds.has(cs.sisId))
                .map(cs => ({
                    id: cs.sisId,
                    canvasName: cs.name,
                    regName: '-',
                    canvasSection: cs.section,
                    facName: '-',
                    status: STATUS.CANVAS_ONLY,
                    section: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'
                }));
        }

        function buildAllRegIds(registrarFiles) {
            const allRegIds = new Set();
            registrarFiles.forEach(rf => {
                const regHeaders = rf.data.headers.map(h => (h || '').toLowerCase().trim());
                const regIdIdx = regHeaders.findIndex(h => h === 'id');
                rf.data.rows.forEach(row => {
                    const id = (row[regIdIdx] || '').trim();
                    if (id) allRegIds.add(id);
                });
            });
            return allRegIds;
        }

        function performStatusCheck(canvasData, registrarFiles) {
            const canvasStudents = extractCanvasStudents(canvasData);

            // Build Canvas SIS ID Map once for O(1) lookups
            const canvasBySisId = new Map();
            canvasStudents.forEach(cs => {
                if (cs.sisId) canvasBySisId.set(cs.sisId, cs);
            });

            const allEntries = [];
            const sectionResults = [];

            registrarFiles.forEach(regFile => {
                const result = compareSection(canvasStudents, canvasBySisId, regFile);
                sectionResults.push(result);
                allEntries.push(...result.matched, ...result.regOnly);
            });

            const allRegIds = buildAllRegIds(registrarFiles);
            const canvasOnlyStudents = findCanvasOnlyStudents(canvasStudents, allRegIds);
            allEntries.push(...canvasOnlyStudents);

            const totalMatched = allEntries.filter(e => e.status === STATUS.MATCH).length;
            const totalRegOnly = allEntries.filter(e => e.status === STATUS.REG_ONLY).length;

            return {
                sections: sectionResults,
                allEntries,
                canvasOnlyStudents,
                canvasTotal: canvasStudents.length,
                regTotal: registrarFiles.reduce((sum, f) => sum + f.data.rows.filter(r => r.some(c => c)).length, 0),
                totalMatched,
                totalIssues: canvasOnlyStudents.length + totalRegOnly
            };
        }

        // ========== STUDENT STATUS CHECK: Rendering ==========

        function groupEntriesBySection(entries) {
            const grouped = {};
            entries.forEach(e => {
                if (!grouped[e.section]) grouped[e.section] = [];
                grouped[e.section].push(e);
            });
            return grouped;
        }

        function renderSectionTable(section, items) {
            const matchCount = items.filter(i => i.status === STATUS.MATCH).length;
            const canvasOnlyCount = items.filter(i => i.status === STATUS.CANVAS_ONLY).length;
            const regOnlyCount = items.filter(i => i.status === STATUS.REG_ONLY).length;

            const rows = items.map(item => `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.canvasName}</td>
                    <td>${item.regName}</td>
                    <td>${item.canvasSection}</td>
                    <td>${item.facName}</td>
                    <td class="${STATUS_CSS[item.status]}">${STATUS_LABELS[item.status]}</td>
                </tr>
            `).join('');

            return `<div class="section-group">
                <div class="section-header">
                    üìã ${section}
                    <span class="badge badge-green">${matchCount} ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</span>
                    ${canvasOnlyCount > 0 ? `<span class="badge badge-yellow">${canvasOnlyCount} ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Canvas</span>` : ''}
                    ${regOnlyCount > 0 ? `<span class="badge badge-red">${regOnlyCount} ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</span>` : ''}
                </div>
                <div class="table-wrap"><table>
                    <thead><tr>
                        <th>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
                        <th>‡∏ä‡∏∑‡πà‡∏≠ (Canvas)</th>
                        <th>‡∏ä‡∏∑‡πà‡∏≠ (‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)</th>
                        <th>Section (Canvas)</th>
                        <th>‡∏Ñ‡∏ì‡∏∞</th>
                        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    </tr></thead>
                    <tbody>${rows}</tbody>
                </table></div>
            </div>`;
        }

        function renderCheckResults() {
            const results = state.check.results;
            if (!results) return;

            const container = document.getElementById('chkResultsContainer');
            let entries = results.allEntries;

            if (state.check.currentFilter !== 'all') {
                entries = entries.filter(e => e.status === state.check.currentFilter);
            }

            if (entries.length === 0) {
                container.innerHTML = '<div class="empty-state">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>';
                return;
            }

            const grouped = groupEntriesBySection(entries);
            container.innerHTML = Object.entries(grouped)
                .map(([section, items]) => renderSectionTable(section, items))
                .join('');
        }

        function filterCheckResults(filter) {
            state.check.currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderCheckResults();
        }

        function updateRegFileList() {
            const files = state.check.registrarFiles;
            const listEl = document.getElementById('regFileList');
            if (files.length === 0) {
                listEl.innerHTML = '';
                return;
            }
            listEl.innerHTML = files.map((f, idx) => `
                <div class="file-item">
                    <div>
                        <span class="file-section">‡∏ß‡∏¥‡∏ä‡∏≤ ${f.courseCode} | Lec ${f.lecSection} | Lab ${f.labSection}</span>
                        <span class="text-muted ml-half">(${f.data.rows.length} ‡∏Ñ‡∏ô)</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:0.75rem;">
                        <span class="text-muted text-small">${f.filename}</span>
                        <span class="file-remove" data-index="${idx}" aria-label="‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå ${f.filename}">‚úï ‡∏•‡∏ö</span>
                    </div>
                </div>
            `).join('');
        }

        // ========== STUDENT STATUS CHECK: Export ==========

        function exportCheckCSV() {
            const results = state.check.results;
            if (!results) return;

            const STATUS_TEXT = {
                [STATUS.MATCH]: '‡∏õ‡∏Å‡∏ï‡∏¥',
                [STATUS.CANVAS_ONLY]: '‡∏°‡∏µ‡πÉ‡∏ô Canvas ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô',
                [STATUS.REG_ONLY]: '‡∏°‡∏µ‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô Canvas'
            };

            const headers = ['‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤', '‡∏ä‡∏∑‡πà‡∏≠ (Canvas)', '‡∏ä‡∏∑‡πà‡∏≠ (‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)', 'Section (Canvas)', '‡∏Ñ‡∏ì‡∏∞', 'Section (‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'];
            let csv = headers.map(escapeCSV).join(',') + '\n';

            results.allEntries.forEach(item => {
                csv += [item.id, item.canvasName, item.regName, item.canvasSection, item.facName, item.section, STATUS_TEXT[item.status] || '']
                    .map(escapeCSV).join(',') + '\n';
            });

            downloadCSV(csv, 'student_status_check');
        }

        // ========== STUDENT STATUS CHECK: Reset ==========

        function resetCheckMode() {
            Object.assign(state.check, {
                canvasData: null, registrarFiles: [],
                currentStep: 1, results: null, currentFilter: 'all'
            });
            resetUploadZone('chkCanvasZone', 'chkCanvasName', '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á', 'chkCanvasInfo', '‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .csv, .xlsx', 'chkCanvasFile');
            resetUploadZone('regZone', 'regName', '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)', 'regInfo', '‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .csv, .xlsx - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô', 'regFiles');
            document.getElementById('regFileList').innerHTML = '';
            document.getElementById('chkBtnNext1').disabled = true;
            document.getElementById('chkBtnCompare').disabled = true;
            hideElement('chkCanvasPreview');
            hideElement('chkCanvasError');
            hideElement('regError');
            updateChkSteps();
        }

        function removeRegFile(idx) {
            state.check.registrarFiles.splice(idx, 1);
            updateRegFileList();
            document.getElementById('chkBtnCompare').disabled = state.check.registrarFiles.length === 0;
            if (state.check.registrarFiles.length === 0) {
                document.getElementById('regZone').classList.remove('has-file');
                document.getElementById('regName').textContent = '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)';
                document.getElementById('regInfo').textContent = '‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .csv, .xlsx - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô';
            }
        }

        // ========== EVENT BINDING ==========

        // Mode selector
        document.getElementById('modeMapBtn').addEventListener('click', () => switchMode('map'));
        document.getElementById('modeCheckBtn').addEventListener('click', () => switchMode('check'));

        // Map mode: Canvas file upload
        document.getElementById('canvasFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            hideElement('canvasPreview');
            hideElement('canvasError');

            try {
                state.map.canvasData = await parseFile(file);

                if (!validateCanvasFile(state.map.canvasData)) {
                    showInlineError('canvasError', '‚ö†Ô∏è ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÑ‡∏ü‡∏•‡πå Grade ‡∏à‡∏≤‡∏Å Canvas<br><small>‡πÑ‡∏ü‡∏•‡πå Canvas ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ columns: Student, ID, SIS User ID, ...</small>');
                    document.getElementById('canvasZone').classList.remove('has-file');
                    document.getElementById('btnNext1').disabled = true;
                    return;
                }

                state.map.assignments = extractAssignments(state.map.canvasData.headers);

                const previewEl = document.getElementById('canvasPreview');
                previewEl.innerHTML = `
                    <div class="text-accent" style="margin-bottom:0.5rem;">‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Canvas:</div>
                    <div>üìã Columns: ${state.map.canvasData.headers.slice(0, CANVAS_FIXED_COLS).join(', ')}</div>
                    <div class="mt-1">üìù Assignments ‡∏ó‡∏µ‡πà‡∏û‡∏ö (${state.map.assignments.length}):</div>
                    <ul class="text-muted" style="margin:0.25rem 0 0 1.25rem;">
                        ${state.map.assignments.slice(0, 5).map(a => `<li>${a.name}</li>`).join('')}
                        ${state.map.assignments.length > 5 ? `<li>... ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${state.map.assignments.length - 5} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>` : ''}
                    </ul>
                `;
                previewEl.classList.remove('hidden');

                document.getElementById('canvasZone').classList.add('has-file');
                document.getElementById('canvasName').innerHTML = `<span class="filename">${file.name}</span>`;
                document.getElementById('canvasInfo').textContent = `‡∏û‡∏ö ${state.map.assignments.length} assignments`;
                document.getElementById('btnNext1').disabled = state.map.assignments.length === 0;

                if (state.map.assignments.length === 0) {
                    showInlineError('canvasError', '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö Assignment ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)');
                }
            } catch (err) {
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ: ' + err.message);
            }
        });

        // Map mode: Score file upload
        document.getElementById('scoreFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            hideElement('errorBox');
            try {
                state.map.scoreData = await parseFile(file);
                const headers = state.map.scoreData.headers.map(h => h.toLowerCase());
                const hasId = headers.some(h => h === 'id' || h === 'student id' || h === 'sis user id');
                const hasEmail = headers.some(h => h.includes('email') || h === 'sis login id');
                if (!hasId && !hasEmail) {
                    showInlineError('errorBox', '‚ö†Ô∏è ‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ID ‡∏´‡∏£‡∏∑‡∏≠ Email ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ü‡∏¥‡∏•‡∏î‡πå');
                    state.map.scoreData = null;
                    return;
                }
                document.getElementById('scoreZone').classList.add('has-file');
                document.getElementById('scoreName').innerHTML = `<span class="filename">${file.name}</span>`;
                document.getElementById('scoreInfo').textContent = `‡∏û‡∏ö ${state.map.scoreData.rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                document.getElementById('btnNext2').disabled = false;

                // Populate score column select
                const sel = document.getElementById('scoreColSelect');
                sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å column --</option>';
                state.map.scoreData.headers.forEach((h, i) => {
                    if (h) sel.innerHTML += `<option value="${i}">${h}</option>`;
                });
                const autoIdx = headers.findIndex(h => h.includes('score') || h.includes('‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô') || h.includes('point'));
                if (autoIdx >= 0) sel.value = autoIdx;
            } catch (err) {
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ: ' + err.message);
            }
        });

        // Map mode: Navigation
        document.getElementById('btnNext1').addEventListener('click', () => { state.map.currentStep = 2; updateMapSteps(); });
        document.getElementById('btnBack2').addEventListener('click', () => { state.map.currentStep = 1; updateMapSteps(); });
        document.getElementById('btnNext2').addEventListener('click', () => {
            state.map.currentStep = 3;
            updateMapSteps();
            const sel = document.getElementById('assignmentSelect');
            sel.innerHTML = state.map.assignments.map(a => `<option value="${a.index}">${a.name}</option>`).join('');
        });
        document.getElementById('btnBack3').addEventListener('click', () => { state.map.currentStep = 2; updateMapSteps(); });

        // Map mode: Scoring mode selection
        document.getElementById('modeScore').addEventListener('click', function() {
            state.map.mappingMode = 'score';
            this.classList.add('selected');
            document.getElementById('modeAttend').classList.remove('selected');
            document.getElementById('scoreColGroup').classList.remove('hidden');
            document.getElementById('attendScoreGroup').classList.add('hidden');
        });
        document.getElementById('modeAttend').addEventListener('click', function() {
            state.map.mappingMode = 'attendance';
            this.classList.add('selected');
            document.getElementById('modeScore').classList.remove('selected');
            document.getElementById('scoreColGroup').classList.add('hidden');
            document.getElementById('attendScoreGroup').classList.remove('hidden');
        });

        // Map mode: Perform mapping
        document.getElementById('btnMap').addEventListener('click', () => {
            const assignmentIdx = parseInt(document.getElementById('assignmentSelect').value);
            const scoreColIdx = parseInt(document.getElementById('scoreColSelect').value);
            const attendScore = parseFloat(document.getElementById('attendScore').value) || 0;

            if (state.map.mappingMode === 'score' && isNaN(scoreColIdx)) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Column ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô');
                return;
            }

            const results = performStudentMatching(
                state.map.canvasData, state.map.scoreData,
                assignmentIdx, state.map.mappingMode, scoreColIdx, attendScore
            );

            state.map.mappingResult = { assignmentIdx, results };
            renderMappingResults(results);

            state.map.currentStep = 4;
            updateMapSteps();
        });

        // Map mode: Export & Reset
        document.getElementById('btnExport').addEventListener('click', exportMappingCSV);
        document.getElementById('btnReset').addEventListener('click', resetMapMode);

        // Check mode: Canvas file upload
        document.getElementById('chkCanvasFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            hideElement('chkCanvasPreview');
            hideElement('chkCanvasError');

            try {
                state.check.canvasData = await parseFile(file);

                if (!validateCanvasFile(state.check.canvasData)) {
                    showInlineError('chkCanvasError', '‚ö†Ô∏è ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÑ‡∏ü‡∏•‡πå Grade ‡∏à‡∏≤‡∏Å Canvas<br><small>‡πÑ‡∏ü‡∏•‡πå Canvas ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ columns: Student, ID, SIS User ID, ...</small>');
                    document.getElementById('chkCanvasZone').classList.remove('has-file');
                    document.getElementById('chkBtnNext1').disabled = true;
                    return;
                }

                const startRow = getPointsRowStart(state.check.canvasData.rows);
                const studentCount = state.check.canvasData.rows.length - startRow;

                const headers = state.check.canvasData.headers.map(h => (h || '').toLowerCase());
                const sectionIdx = headers.findIndex(h => h === 'section');
                const sections = new Set();
                if (sectionIdx >= 0) {
                    state.check.canvasData.rows.slice(startRow).forEach(row => {
                        if (row[sectionIdx]) sections.add(row[sectionIdx]);
                    });
                }

                const previewEl = document.getElementById('chkCanvasPreview');
                previewEl.innerHTML = `
                    <div class="text-accent" style="margin-bottom:0.5rem;">‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Canvas:</div>
                    <div>üë• ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤: ${studentCount} ‡∏Ñ‡∏ô</div>
                    ${sections.size > 0 ? `<div>üìã Sections: ${[...sections].join(', ')}</div>` : ''}
                `;
                previewEl.classList.remove('hidden');

                document.getElementById('chkCanvasZone').classList.add('has-file');
                document.getElementById('chkCanvasName').innerHTML = `<span class="filename">${file.name}</span>`;
                document.getElementById('chkCanvasInfo').textContent = `‡∏û‡∏ö ${studentCount} ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤`;
                document.getElementById('chkBtnNext1').disabled = false;
            } catch (err) {
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ: ' + err.message);
            }
        });

        // Check mode: Registrar files upload
        document.getElementById('regFiles').addEventListener('change', async (e) => {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            hideElement('regError');

            const newFiles = [];
            const errors = [];

            for (const file of files) {
                const sectionInfo = parseRegFilename(file.name);
                if (!sectionInfo) {
                    errors.push(`${file.name}: ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤6‡∏ï‡∏±‡∏ß + lecSection3‡∏ï‡∏±‡∏ß + labSection3‡∏ï‡∏±‡∏ß)`);
                    continue;
                }

                try {
                    const data = await parseFile(file);
                    const headers = data.headers.map(h => (h || '').toLowerCase().trim());
                    if (!headers.some(h => h === 'id')) {
                        errors.push(`${file.name}: ‡πÑ‡∏°‡πà‡∏û‡∏ö column ID ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå`);
                        continue;
                    }

                    const key = sectionInfo.courseCode + sectionInfo.lecSection + sectionInfo.labSection;
                    const existing = state.check.registrarFiles.findIndex(f =>
                        f.courseCode + f.lecSection + f.labSection === key);
                    if (existing >= 0) {
                        state.check.registrarFiles.splice(existing, 1);
                    }

                    newFiles.push({
                        filename: file.name,
                        courseCode: sectionInfo.courseCode,
                        lecSection: sectionInfo.lecSection,
                        labSection: sectionInfo.labSection,
                        data: data
                    });
                } catch (err) {
                    errors.push(`${file.name}: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ - ${err.message}`);
                }
            }

            state.check.registrarFiles = state.check.registrarFiles.concat(newFiles);

            if (errors.length > 0) {
                showInlineError('regError', errors.map(err => '‚ö†Ô∏è ' + err).join('<br>'));
            }

            updateRegFileList();
            document.getElementById('chkBtnCompare').disabled = state.check.registrarFiles.length === 0;
            if (state.check.registrarFiles.length > 0) {
                document.getElementById('regZone').classList.add('has-file');
                document.getElementById('regName').innerHTML = `<span class="filename">${state.check.registrarFiles.length} ‡πÑ‡∏ü‡∏•‡πå</span>`;
                document.getElementById('regInfo').textContent = `‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå`;
            }
        });

        // Check mode: Registrar file list - event delegation for remove buttons
        document.getElementById('regFileList').addEventListener('click', (e) => {
            const removeBtn = e.target.closest('.file-remove');
            if (removeBtn) {
                const idx = parseInt(removeBtn.dataset.index, 10);
                removeRegFile(idx);
            }
        });

        // Check mode: Navigation
        document.getElementById('chkBtnNext1').addEventListener('click', () => { state.check.currentStep = 2; updateChkSteps(); });
        document.getElementById('chkBtnBack2').addEventListener('click', () => { state.check.currentStep = 1; updateChkSteps(); });

        // Check mode: Perform comparison
        document.getElementById('chkBtnCompare').addEventListener('click', () => {
            if (!state.check.canvasData || state.check.registrarFiles.length === 0) return;

            state.check.results = performStatusCheck(state.check.canvasData, state.check.registrarFiles);
            const results = state.check.results;

            document.getElementById('chkStatCanvas').textContent = results.canvasTotal;
            document.getElementById('chkStatReg').textContent = results.regTotal;
            document.getElementById('chkStatMatch').textContent = results.totalMatched;
            document.getElementById('chkStatIssue').textContent = results.totalIssues;

            state.check.currentFilter = 'all';
            renderCheckResults();

            state.check.currentStep = 3;
            updateChkSteps();
        });

        // Check mode: Filter buttons - event delegation
        document.querySelector('.filter-bar').addEventListener('click', (e) => {
            const btn = e.target.closest('.filter-btn');
            if (btn && btn.dataset.filter) {
                filterCheckResults(btn.dataset.filter);
            }
        });

        // Check mode: Export & Reset
        document.getElementById('chkBtnExport').addEventListener('click', exportCheckCSV);
        document.getElementById('chkBtnReset').addEventListener('click', resetCheckMode);

        // ========== INITIALIZATION ==========
        updateMapSteps();
    </script>
</body>
</html>
